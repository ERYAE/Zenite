<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ZENITE OS // FICHA DINÂMICA</title>
    
    <!-- CORE STACK -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Orbitron:wght@400;500;700;900&family=Rajdhani:wght@300;500;600;700&display=swap');

        :root {
            --bg-void: #050507;
            --glass-panel: rgba(20, 20, 25, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --neon-core: #0ea5e9;
            --neon-alert: #ef4444;
            --neon-success: #10b981;
            --neon-warn: #f59e0b;
            --neon-purple: #d946ef;
        }

        [x-cloak] { display: none !important; }

        body {
            font-family: 'Rajdhani', sans-serif;
            background-color: var(--bg-void);
            color: #e2e8f0;
            background-image: 
                radial-gradient(circle at 50% 0%, rgba(14, 165, 233, 0.05), transparent 70%),
                linear-gradient(0deg, rgba(255,255,255,0.02) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 100% 100%, 40px 40px, 40px 40px;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* FX LAYERS */
        #damage-overlay, #heal-overlay { position: fixed; inset: 0; pointer-events: none; z-index: 90; mix-blend-mode: overlay; opacity: 0; transition: opacity 0.2s ease-out; }
        #damage-overlay { background: radial-gradient(circle, transparent 50%, var(--neon-alert) 100%); }
        #heal-overlay { background: radial-gradient(circle, transparent 50%, var(--neon-core) 100%); }

        /* UI COMPONENTS */
        .glass {
            background: var(--glass-panel);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        .input-cyber {
            background: rgba(0,0,0,0.5);
            border: 1px solid var(--glass-border);
            color: white;
            transition: all 0.3s ease;
            font-family: 'Rajdhani', sans-serif;
        }
        .input-cyber:focus { border-color: var(--neon-core); box-shadow: 0 0 15px rgba(14, 165, 233, 0.2); outline: none; }

        .btn-action {
            position: relative; overflow: hidden; transition: all 0.3s;
            font-family: 'Orbitron', sans-serif; letter-spacing: 1px; text-transform: uppercase;
        }
        .btn-action:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .btn-action:active { transform: translateY(0); }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-core); }

        /* ANIMATIONS */
        .crit-success { text-shadow: 0 0 15px var(--neon-warn); color: var(--neon-warn) !important; animation: pulseGold 0.5s infinite; }
        .crit-fail { text-shadow: 0 0 15px var(--neon-alert); color: var(--neon-alert) !important; animation: shake 0.3s; }
        @keyframes pulseGold { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-3px); } 75% { transform: translateX(3px); } }
        
        /* EXTRAS */
        .cropper-view-box, .cropper-face { border-radius: 50%; }
        .cropper-container { width: 100% !important; height: 100% !important; }
        .skill-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid var(--glass-border); cursor: pointer; transition: all 0.2s; }
        .skill-dot.active { background: var(--neon-core); box-shadow: 0 0 8px var(--neon-core); border-color: var(--neon-core); }
    </style>

    <script>
        const MAX_AGENTS = 30;
        const APP_VERSION = 'v12.1';

        // Define Global Function for Alpine x-data
function zeniteSystem() {
    return {
        // --- AUTH STATE ---
        authToken: localStorage.getItem('zenite_token') || null,
        authInput: { user: '', pass: '' },
        authLoading: false,
        authMsg: '',
        authMsgType: '',

        // --- APP STATE ---
        currentView: 'dashboard',
        chars: {},
        activeCharId: null,
        char: null,
        
        // --- UI ---
        activeTab: 'profile',
        logisticsTab: 'inventory',
        notifications: [],
        configModal: false,
        
        // --- DICE ---
        showDiceLog: false,
        diceLog: [],
        lastRoll: '--',
        lastNatural: 0,
        lastFaces: 0,
        diceMod: 0,

        // --- WIZARD & EXTRAS ---
        wizardOpen: false,
        wizardStep: 1,
        wizardData: { class: '', attrs: {for:-1, agi:-1, int:-1, von:-1, pod:-1} },
        wizardPoints: 8,
        wizardFocusAttr: '',
        cropperOpen: false,
        cropperInstance: null,
        agentCount: 0,
        _saveTimer: null,

        archetypes: [
            { class: 'Titã', desc: 'Resiliência e força bruta.', icon: 'fa-solid fa-shield-halved', focus: 'for', color: 'text-rose-500' },
            { class: 'Estrategista', desc: 'Análise tática e liderança.', icon: 'fa-solid fa-chess', focus: 'int', color: 'text-cyan-500' },
            { class: 'Infiltrador', desc: 'Furtividade e precisão.', icon: 'fa-solid fa-user-ninja', focus: 'agi', color: 'text-emerald-500' },
            { class: 'Controlador', desc: 'Manipulação de energia.', icon: 'fa-solid fa-hand-spock', focus: 'pod', color: 'text-violet-500' },
            { class: 'Psíquico', desc: 'Domínio mental.', icon: 'fa-solid fa-brain', focus: 'von', color: 'text-amber-500' }
        ],

        initSystem() {
            if (this.authToken) {
                this.fetchData();
            }
            this.$watch('char', (val) => {
                if (val && this.currentView === 'sheet') {
                    clearTimeout(this._saveTimer);
                    this._saveTimer = setTimeout(() => {
                        this.saveData(); // Agora salva no DB
                        if(this.activeTab === 'profile') this.updateRadarChart();
                    }, 1000); // Aumentei o delay para não floodar o servidor
                }
            });
        },

        // --- AUTHENTICATION ---
        async doAuth(action) {
            if(!this.authInput.user || !this.authInput.pass) return this.authMsg = 'Preencha tudo.';
            this.authLoading = true;
            this.authMsg = 'Processando...';
            
            try {
                const req = await fetch('/api/auth', {
                    method: 'POST',
                    body: JSON.stringify({ action, username: this.authInput.user, password: this.authInput.pass })
                });
                const res = await req.json();
                
                if (req.status !== 200) throw new Error(res.error || 'Erro.');

                if (action === 'register') {
                    this.authMsg = 'Conta criada! Faça login.';
                    this.authMsgType = 'success';
                } else {
                    // Login Success
                    this.authToken = res.token;
                    localStorage.setItem('zenite_token', res.token); // Salva token localmente para manter logado
                    this.chars = res.data || {};
                    this.updateAgentCount();
                    this.authMsg = '';
                }
            } catch (e) {
                this.authMsg = e.message;
                this.authMsgType = 'error';
            } finally {
                this.authLoading = false;
            }
        },

logout() {
    if (confirm("Desconectar do sistema?")) {
        // 1. Limpa o token da memória e do navegador
        this.authToken = null;
        localStorage.removeItem('zenite_token');
        
        // 2. Limpa os dados visuais para segurança
        this.chars = {};
        this.char = null;
        this.activeCharId = null;
        
        // 3. Reseta a vista
        this.currentView = 'dashboard';
        this.notify('Sessão encerrada.', 'info');
},

        // --- DATA CORE (API) ---
        async fetchData() {
            try {
                const req = await fetch('/api/data', {
                    headers: { 'Authorization': `Bearer ${this.authToken}` }
                });
                if(req.status === 401) return this.logout(); // Token expirou
                const data = await req.json();
                this.chars = data || {};
                this.updateAgentCount();
            } catch(e) { console.error(e); this.notify('Erro de conexão', 'error'); }
        },

        async saveData() {
            if (!this.authToken) return;
            try {
                // Atualiza o objeto principal antes de enviar
                if (this.char && this.activeCharId) {
                    this.chars[this.activeCharId] = JSON.parse(JSON.stringify(this.char));
                }
                
                await fetch('/api/data', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${this.authToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ data: this.chars })
                });
                
                this.updateAgentCount();
                // Opcional: Notificar salvamento silencioso
            } catch(e) {
                this.notify('Falha ao salvar na nuvem!', 'error');
            }
        },

        updateAgentCount() { this.agentCount = Object.keys(this.chars).length; },

        loadCharacter(id) {
            this.activeCharId = id;
            this.char = JSON.parse(JSON.stringify(this.chars[id]));
            
            // Migrations e Inicialização de campos vazios
            if(!this.char.inventory.weapons) this.char.inventory = { weapons:[], armor:[], gear:[], backpack: "", social: { people:[], objects:[] } };
            if(!this.char.inventory.social) this.char.inventory.social = { people:[], objects:[] };
            if(!this.char.skills) this.char.skills = [];
            if(!this.char.powers.techniques) this.char.powers.techniques = [];
            if(!this.char.stats.pdf) this.char.stats.pdf = { current: 10, max: 10 };

            this.currentView = 'sheet';
            this.activeTab = 'profile';
            setTimeout(() => this.updateRadarChart(), 100);
        },

        deleteCharacter(id) {
            if (window.confirm('ATENÇÃO: Excluir este agente permanentemente?')) {
                delete this.chars[id];
                this.saveData(); // Salva a deleção
                this.updateAgentCount();
                this.notify('Agente eliminado.', 'success');
            }
        },

        // MANTENHA TODO O RESTO DO CÓDIGO (recalcDerivedStats, modStat, triggerFX, charts, cropper, etc...)
        // Exatamente como estava no original daqui para baixo...
        
        recalcDerivedStats() {
            if(!this.char) return;
            const c = this.char;
            const lvl = Math.min(10, Math.max(1, parseInt(c.level) || 1));
            c.level = lvl;

            const getV = (v) => parseInt(v) || 0;
            const FOR = getV(c.attrs.for);
            const AGI = getV(c.attrs.agi);
            const INT = getV(c.attrs.int);
            const VON = getV(c.attrs.von);
            const POD = getV(c.attrs.pod);

            let maxPV = 0, maxPF = 0, maxPDF = 0;

            if (c.class === 'Titã') {
                maxPV = (15 + FOR) + ((4 + FOR) * (lvl - 1));
                maxPF = (12 + POD) + ((2 + POD) * (lvl - 1));
                maxPDF = (10 + VON) + ((2 + VON) * (lvl - 1));
            } else if (c.class === 'Estrategista') {
                maxPV = (12 + FOR) + ((2 + FOR) * (lvl - 1));
                maxPF = (15 + POD) + ((4 + POD) * (lvl - 1));
                maxPDF = (12 + VON) + ((2 + VON) * (lvl - 1));
            } else if (c.class === 'Infiltrador') {
                maxPV = (12 + FOR) + ((2 + FOR) * (lvl - 1));
                maxPF = (12 + POD) + ((2 + POD) * (lvl - 1));
                maxPDF = (12 + VON) + ((3 + VON) * (lvl - 1));
            } else if (c.class === 'Controlador') {
                maxPV = (12 + FOR) + ((2 + FOR) * (lvl - 1));
                maxPF = (12 + POD) + ((2 + POD) * (lvl - 1));
                maxPDF = (15 + VON) + ((4 + VON) * (lvl - 1));
            } else if (c.class === 'Psíquico') {
                maxPV = (12 + FOR) + ((2 + FOR) * (lvl - 1));
                maxPF = (13 + POD) + ((3 + POD) * (lvl - 1));
                maxPDF = (14 + VON) + ((3 + VON) * (lvl - 1));
            } else {
                maxPV = (12 + FOR) + ((2 + FOR) * (lvl - 1));
                maxPF = (10 + POD) + ((2 + POD) * (lvl - 1));
                maxPDF = (10 + VON) + ((2 + VON) * (lvl - 1));
            }

            c.stats.pv.max = Math.max(5, maxPV);
            c.stats.pf.max = Math.max(5, maxPF);
            c.stats.pdf.max = Math.max(5, maxPDF);
        },

        modStat(type, val) {
            const stat = this.char.stats[type];
            const oldVal = stat.current;
            stat.current = Math.min(Math.max(0, stat.current + val), stat.max);
            
            if (stat.current < oldVal && type === 'pv') this.triggerFX('damage');
            if (stat.current > oldVal) this.triggerFX('heal');
            this.saveData(); // Salva alteração
        },

        modAttr(key, val) {
            const current = this.char.attrs[key];
            if (val > 0 && current < 6) this.char.attrs[key]++;
            if (val < 0 && current > -1) this.char.attrs[key]--;
            
            this.recalcDerivedStats();
            this.updateRadarChart();
        },

        updateClassLogic() {
            const arch = this.archetypes.find(a => a.class === this.char.class);
            if (arch && this.char.attrs[arch.focus] < 0) {
                this.char.attrs[arch.focus] = 0;
                this.notify(`Atributo Foco (${arch.focus}) ajustado.`, 'info');
            }
            this.recalcDerivedStats();
            this.updateRadarChart();
        },

        triggerFX(type) {
            const el = document.getElementById(type + '-overlay');
            if(el) { el.style.opacity = '0.4'; setTimeout(() => el.style.opacity = '0', 200); }
        },

        // --- WIZARD ---
        openWizard() {
            if (this.agentCount >= MAX_AGENTS) return this.notify('Limite de agentes atingido.', 'error');
            this.wizardOpen = true;
            this.wizardStep = 1;
            this.wizardData = { class: '', attrs: {for:-1, agi:-1, int:-1, von:-1, pod:-1} };
            this.wizardPoints = 8;
        },

        selectArchetype(arch) {
            this.wizardData.class = arch.class;
            this.wizardData.attrs = {for:-1, agi:-1, int:-1, von:-1, pod:-1};
            this.wizardFocusAttr = arch.focus;
            this.wizardData.attrs[arch.focus] = 0;
            this.wizardStep = 2;
            this.wizardPoints = 8;
            setTimeout(() => this.updateWizardChart(), 50);
        },

        modWizardAttr(key, val) {
            const current = this.wizardData.attrs[key];
            const isFocus = key === this.wizardFocusAttr;
            const min = isFocus ? 0 : -1;
            
            if (val > 0) {
                if (this.wizardPoints > 0 && current < 3) {
                    this.wizardData.attrs[key]++;
                    this.wizardPoints--;
                }
            } else {
                if (current > min) {
                    this.wizardData.attrs[key]--;
                    this.wizardPoints++;
                }
            }
            this.updateWizardChart();
        },

        finishWizard() {
            const id = 'z_' + Date.now();
            const tempChar = { 
                class: this.wizardData.class, 
                level: 1, 
                attrs: this.wizardData.attrs,
                stats: { pv:{}, pf:{}, pdf:{} }
            };
            
            const oldChar = this.char;
            this.char = tempChar;
            this.recalcDerivedStats();
            this.char = oldChar; 

            const newChar = {
                id: id,
                name: '', identity: '', class: this.wizardData.class, level: 1, photo: '', history: '', credits: 0,
                stats: {
                    pv: { current: tempChar.stats.pv.max, max: tempChar.stats.pv.max },
                    pf: { current: tempChar.stats.pf.max, max: tempChar.stats.pf.max },
                    pdf: { current: tempChar.stats.pdf.max, max: tempChar.stats.pdf.max }
                },
                attrs: {...this.wizardData.attrs},
                inventory: { weapons: [], armor: [], gear: [], backpack: "", social: {people:[], objects:[]} },
                skills: [],
                powers: { passive: '', active: '', trackName: '', techniques: [], lvl3: '', lvl6: '', lvl9: '', lvl10: '' }
            };
            
            this.chars[id] = newChar;
            this.saveData(); // Salva novo char
            this.wizardOpen = false;
            this.loadCharacter(id);
            this.notify('Agente Inicializado.', 'success');
        },

        // --- INVENTORY & LISTS ---
        addItem(cat) {
            const defs = {
                weapons: { name: 'Nova Arma', dmg: '1d6', range: 'C' },
                armor: { name: 'Traje', def: '1', pen: '0' },
                gear: { name: 'Item', desc: '', qty: 1 },
                social_people: { name: 'Nome', role: 'Relação' },
                social_objects: { name: 'Objeto', desc: 'Detalhes' }
            };
            if(cat.startsWith('social_')) {
                this.char.inventory.social[cat.split('_')[1]].push({...defs[cat]});
            } else {
                this.char.inventory[cat].push({...defs[cat]});
            }
            this.saveData();
        },
        deleteItem(cat, idx, subcat=null) {
            if(subcat) this.char.inventory[cat][subcat].splice(idx, 1);
            else this.char.inventory[cat].splice(idx, 1);
            this.saveData();
        },

        // --- SKILLS ---
        addSkill() {
            this.char.skills.push({ name: 'Nova Perícia', level: 1 });
            this.saveData();
        },
        deleteSkill(idx) {
            this.char.skills.splice(idx, 1);
            this.saveData();
        },
        setSkillLevel(idx, lvl) {
            this.char.skills[idx].level = lvl;
            this.saveData();
        },

        // --- TECHNIQUES ---
        addTechnique() {
            this.char.powers.techniques.push({ name: 'Nova Técnica', desc: 'Efeito...' });
            this.saveData();
        },
        deleteTechnique(idx) {
            this.char.powers.techniques.splice(idx, 1);
            this.saveData();
        },

        // --- CHARTS ---
        renderChart(id, attrs, color) {
            const ctx = document.getElementById(id);
            if (!ctx) return;
            const data = [attrs.for, attrs.agi, attrs.int, attrs.von, attrs.pod];
            if (ctx.chart) { ctx.chart.data.datasets[0].data = data; ctx.chart.update(); return; }
            ctx.chart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['FOR', 'AGI', 'INT', 'VON', 'POD'],
                    datasets: [{ data: data, backgroundColor: `rgba(${color}, 0.2)`, borderColor: `rgba(${color}, 1)`, borderWidth: 2, pointBackgroundColor: '#fff', pointRadius: 3 }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { r: { min: -1, max: 6, ticks: { display: false }, grid: { color: 'rgba(255,255,255,0.05)' }, angleLines: { color: 'rgba(255,255,255,0.05)' }, pointLabels: { color: '#94a3b8', font: { size: 9, family: 'Orbitron' } } } },
                    plugins: { legend: { display: false } }
                }
            });
        },
        updateRadarChart() { this.renderChart('radarChart', this.char.attrs, '14, 165, 233'); },
        updateWizardChart() { this.renderChart('wizChart', this.wizardData.attrs, '255, 255, 255'); },

        // --- RNG ---
        roll(sides) {
            const arr = new Uint32Array(1);
            window.crypto.getRandomValues(arr);
            const natural = (arr[0] % sides) + 1;
            this.lastNatural = natural; this.lastFaces = sides;
            this.lastRoll = natural + parseInt(this.diceMod || 0);
            const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            this.diceLog.unshift({ id: Date.now(), time, formula: `D${sides}${this.diceMod>=0?'+':''}${this.diceMod}`, natural, result: this.lastRoll, crit: natural===sides, fumble: natural===1 });
            if(this.diceLog.length>8) this.diceLog.pop();
        },

        // --- CROPPER ---
        openImageEditor() { document.getElementById('file-input').click(); },
        initCropper(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                document.getElementById('crop-target').src = evt.target.result;
                this.cropperOpen = true;
                this.$nextTick(() => {
                    if(this.cropperInstance) this.cropperInstance.destroy();
                    this.cropperInstance = new Cropper(document.getElementById('crop-target'), { aspectRatio: 1, viewMode: 1, guides: false, background: false, autoCropArea: 1 });
                });
            };
            reader.readAsDataURL(file);
        },
        applyCrop() {
            if(!this.cropperInstance) return;
            this.char.photo = this.cropperInstance.getCroppedCanvas({width: 300, height: 300}).toDataURL('image/jpeg', 0.8);
            this.cropperOpen = false;
            this.saveData();
            this.notify('Foto atualizada.', 'success');
        },

        // --- SYSTEM UTILS ---
        notify(msg, type='info') {
            const id = Date.now();
            this.notifications.push({id, message: msg, type, dismissed: false});
            setTimeout(() => { this.notifications = this.notifications.filter(n => n.id !== id); }, 3000);
        },
        exportData() {
            const str = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(this.chars));
            const a = document.createElement('a'); a.href = str; a.download = `zenite_bkp_${Date.now()}.json`; a.click();
        },
        importData(e) {
            const file = e.target.files[0]; if(!file) return;
            const r = new FileReader();
            r.onload = (evt) => {
                try { this.chars = JSON.parse(evt.target.result); this.saveData(); this.notify('Backup restaurado.', 'success'); this.configModal = false; location.reload(); } 
                catch(err) { this.notify('Arquivo inválido.', 'error'); }
            };
            r.readAsText(file);
        },
        hardReset() {
            if (window.confirm('PERIGO: RESETAR O SISTEMA INTEIRO?')) {
               // Apenas limpa a view local, não deleta do banco para segurança, ou implemente uma rota de delete user
               this.chars = {};
               this.saveData();
               this.notify('Dados limpos.', 'warn');
            }
        }
    }
}
    </script>
</head>
<body x-data="zeniteSystem()" x-init="initSystem()" class="text-gray-300 selection:bg-cyan-500 selection:text-black" x-cloak>

    <!-- DATABASE -->
<div x-show="!authToken" class="fixed inset-0 z-[200] bg-black flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-[#0a0a0a] border border-[var(--neon-core)] rounded-xl p-8 shadow-[0_0_50px_rgba(14,165,233,0.2)] text-center">
        <div class="mb-8">
            <h1 class="text-4xl font-brand text-white mb-2">ZENITE <span class="text-[var(--neon-core)]">OS</span></h1>
            <p class="text-gray-500 font-code text-xs">ACESSO RESTRITO // BANCO DE DADOS NEON</p>
        </div>
        
        <div class="space-y-4">
            <input x-model="authInput.user" type="text" placeholder="USUÁRIO" class="input-cyber w-full p-3 text-center uppercase">
            <input x-model="authInput.pass" type="password" placeholder="SENHA" class="input-cyber w-full p-3 text-center">
            
            <div class="grid grid-cols-2 gap-4 mt-6">
                <button @click="doAuth('login')" :disabled="authLoading" class="btn-action py-3 bg-[var(--neon-core)] text-black font-bold rounded">
                    <span x-show="!authLoading">LOGIN</span>
                    <span x-show="authLoading"><i class="fa-solid fa-spinner fa-spin"></i></span>
                </button>
                <button @click="doAuth('register')" :disabled="authLoading" class="btn-action py-3 border border-white/20 hover:bg-white/5 rounded">REGISTRAR</button>
            </div>
            <p x-text="authMsg" class="text-xs font-bold mt-4 h-4" :class="authMsgType === 'error' ? 'text-red-500' : 'text-green-500'"></p>
        </div>
    </div>
</div>

    <!-- FX OVERLAYS -->
    <div id="damage-overlay"></div>
    <div id="heal-overlay"></div>

    <!-- TOASTS -->
    <div class="fixed top-5 right-5 z-[100] space-y-2 pointer-events-none">
        <template x-for="n in notifications" :key="n.id">
            <div class="glass border-l-4 px-6 py-3 rounded shadow-2xl flex items-center gap-3 transition-all duration-500 transform translate-x-0"
                 :class="{'border-green-500': n.type==='success', 'border-red-500': n.type==='error', 'border-blue-500': n.type==='info'}">
                <span x-text="n.message" class="font-bold text-xs tracking-wider text-white font-brand"></span>
            </div>
        </template>
    </div>

    <!-- HEADER -->
    <header class="relative z-20 max-w-7xl mx-auto p-6 flex flex-col md:flex-row justify-between items-center border-b border-white/5">
        <div class="flex items-center gap-4 mb-4 md:mb-0">
            <div class="w-14 h-14 rounded-xl bg-black border border-[var(--neon-core)] flex items-center justify-center shadow-[0_0_20px_rgba(14,165,233,0.2)]">
                <span class="font-brand text-3xl font-bold text-white">Z</span>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-white tracking-widest font-brand">ZENITE <span class="text-[var(--neon-core)] text-xs">OS</span></h1>
                <p class="text-[10px] text-gray-500 font-code">V12.0</p>
            </div>
        </div>
<div class="flex gap-3">
    <button x-show="authToken" @click="logout()" class="btn-action w-10 h-10 rounded glass border border-red-500/30 text-red-500 hover:bg-red-500/20 flex items-center justify-center transition-colors" title="Sair">
        <i class="fa-solid fa-power-off"></i>
    </button>

    <button @click="configModal=true" class="btn-action w-10 h-10 rounded glass border border-white/10 hover:border-[var(--neon-core)] flex items-center justify-center">
        <i class="fa-solid fa-gear"></i>
    </button>
    
    <button @click="openWizard()" class="btn-action px-6 py-2 rounded bg-[var(--neon-core)] text-black font-bold shadow-lg hover:scale-105 flex items-center gap-2">
        <i class="fa-solid fa-plus"></i> <span class="hidden md:inline">NOVO AGENTE</span>
    </button>
</div>
    </header>

    <!-- DASHBOARD -->
    <main x-show="currentView === 'dashboard'" class="relative z-10 max-w-7xl mx-auto p-6 pb-32" x-transition.opacity>
        <div class="mb-8 flex justify-between items-end border-b border-white/5 pb-2">
            <h2 class="text-sm font-bold text-gray-500 uppercase tracking-widest">Banco de Dados</h2>
            <div class="text-[10px] font-code text-gray-600">SLOTS: <span x-text="agentCount" class="text-white font-bold"></span> / 30</div>
        </div>

        <div x-show="agentCount === 0" class="py-32 text-center opacity-30">
            <i class="fa-solid fa-network-wired text-6xl mb-4"></i>
            <p class="font-brand">SISTEMA VAZIO</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <template x-for="(c, id) in chars" :key="id">
                <div @click="loadCharacter(id)" class="glass p-5 rounded-xl border border-white/5 hover:border-[var(--neon-core)] hover:bg-white/[0.02] transition-all cursor-pointer group relative overflow-hidden">
                    <div class="flex items-center gap-5 relative z-10">
                        <img :src="c.photo || 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'" class="w-16 h-16 rounded-full object-cover border border-white/20 bg-black">
                        <div>
                            <h3 class="text-white font-bold truncate font-brand text-lg group-hover:text-[var(--neon-core)]" x-text="c.name || 'DESCONHECIDO'"></h3>
                            <p class="text-[10px] text-gray-400 font-code uppercase" x-text="c.class + ' // NV ' + c.level"></p>
                        </div>
                    </div>
                    <!-- DELETE BUTTON WITH FIXED EVENT HANDLER -->
                    <button @click.stop="deleteCharacter(id)" class="absolute top-3 right-3 text-gray-600 hover:text-red-500 z-20 p-2 transition-colors opacity-0 group-hover:opacity-100 bg-black/50 rounded"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            </template>
        </div>
    </main>

    <!-- SHEET -->
    <template x-if="currentView === 'sheet' && char">
        <main class="relative z-10 max-w-7xl mx-auto p-4 pb-40" x-transition.opacity>
            <!-- NAV -->
            <div class="glass p-2 rounded-xl flex flex-wrap justify-between items-center gap-4 mb-6 sticky top-2 z-40 backdrop-blur-xl border border-white/10">
                <div class="flex items-center gap-3 px-2">
                    <button @click="currentView = 'dashboard'; activeCharId = null;" class="text-gray-400 hover:text-white text-xs font-bold uppercase flex items-center gap-2"><i class="fa-solid fa-chevron-left"></i> VOLTAR</button>
                    <div class="w-px h-4 bg-white/10"></div>
                    <span class="text-[10px] font-code text-[var(--neon-core)]" x-text="activeCharId.slice(-6)"></span>
                </div>
                <div class="flex gap-1 bg-black/40 p-1 rounded-lg">
                    <button @click="activeTab='profile'" :class="activeTab==='profile'?'bg-[var(--neon-core)] text-black shadow-lg':'text-gray-500 hover:text-white'" class="px-4 py-1.5 rounded text-xs font-bold uppercase transition-all">Perfil</button>
                    <button @click="activeTab='powers'" :class="activeTab==='powers'?'bg-[var(--neon-core)] text-black shadow-lg':'text-gray-500 hover:text-white'" class="px-4 py-1.5 rounded text-xs font-bold uppercase transition-all">Poderes</button>
                    <button @click="activeTab='logistics'" :class="activeTab==='logistics'?'bg-[var(--neon-core)] text-black shadow-lg':'text-gray-500 hover:text-white'" class="px-4 py-1.5 rounded text-xs font-bold uppercase transition-all">Logística</button>
                </div>
            </div>

            <!-- TAB PROFILE -->
            <div x-show="activeTab === 'profile'" class="grid grid-cols-1 lg:grid-cols-12 gap-6 animate-fade-in">
                <!-- LEFT: VITALS -->
                <div class="lg:col-span-4 space-y-6">
                    <div class="glass p-6 rounded-xl text-center relative group">
                        <div @click="openImageEditor()" class="w-32 h-32 mx-auto rounded-full border-2 border-dashed border-white/20 hover:border-[var(--neon-core)] cursor-pointer overflow-hidden bg-black relative">
                            <img :src="char.photo" class="w-full h-full object-cover" x-show="char.photo">
                            <div class="absolute inset-0 flex items-center justify-center bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-camera text-white"></i></div>
                        </div>
                        
                        <div class="mt-4 flex justify-center">
                            <div class="bg-black/40 px-4 py-2 rounded border border-white/10 flex items-center gap-2">
                                <label class="text-[10px] text-gray-500 font-bold">NÍVEL</label>
                                <input type="number" x-model="char.level" min="1" max="10" @change="recalcDerivedStats(); saveData()" class="bg-transparent w-12 text-center text-xl font-bold text-white outline-none">
                            </div>
                        </div>
                        
                        <!-- VITALS CONTROLS -->
                        <div class="mt-6 space-y-3 text-left">
                            <!-- PV -->
                            <div class="bg-black/40 p-3 rounded border border-white/5 hover:border-red-500/30 transition-colors">
                                <div class="flex justify-between text-[10px] font-bold mb-1">
                                    <span class="text-red-500">PV (VIDA)</span>
                                    <div class="flex gap-1 text-white font-code">
                                        <span x-text="char.stats.pv.current"></span> / 
                                        <input type="number" x-model="char.stats.pv.max" @change="saveData()" class="bg-transparent w-10 text-right outline-none text-gray-400 focus:text-white border-b border-transparent focus:border-red-500">
                                    </div>
                                </div>
                                <div class="h-1.5 bg-gray-800 rounded-full overflow-hidden"><div class="h-full bg-red-500 transition-all" :style="`width:${Math.min(100, (char.stats.pv.current/char.stats.pv.max)*100)}%`"></div></div>
                                <div class="flex gap-1 mt-2">
                                    <button @click="modStat('pv', -5)" class="px-2 bg-red-900/20 text-red-500 text-xs rounded hover:bg-red-500 hover:text-black font-bold">-5</button>
                                    <button @click="modStat('pv', -1)" class="flex-1 bg-red-900/20 text-red-500 text-xs py-1 hover:bg-red-500 hover:text-black rounded">-1</button>
                                    <button @click="modStat('pv', 1)" class="flex-1 bg-green-900/20 text-green-500 text-xs py-1 hover:bg-green-500 hover:text-black rounded">+1</button>
                                    <button @click="modStat('pv', 5)" class="px-2 bg-green-900/20 text-green-500 text-xs rounded hover:bg-green-500 hover:text-black font-bold">+5</button>
                                </div>
                            </div>
                            <!-- PF -->
                            <div class="bg-black/40 p-3 rounded border border-white/5 hover:border-amber-500/30 transition-colors">
                                <div class="flex justify-between text-[10px] font-bold mb-1">
                                    <span class="text-amber-500">PF (ESFORÇO)</span>
                                    <div class="flex gap-1 text-white font-code">
                                        <span x-text="char.stats.pf.current"></span> / 
                                        <input type="number" x-model="char.stats.pf.max" @change="saveData()" class="bg-transparent w-10 text-right outline-none text-gray-400 focus:text-white border-b border-transparent focus:border-amber-500">
                                    </div>
                                </div>
                                <div class="h-1.5 bg-gray-800 rounded-full overflow-hidden"><div class="h-full bg-amber-500 transition-all" :style="`width:${Math.min(100, (char.stats.pf.current/char.stats.pf.max)*100)}%`"></div></div>
                                <div class="flex gap-1 mt-2">
                                    <button @click="modStat('pf', -5)" class="px-2 bg-amber-900/20 text-amber-500 text-xs rounded hover:bg-amber-500 hover:text-black font-bold">-5</button>
                                    <button @click="modStat('pf', -1)" class="flex-1 bg-amber-900/20 text-amber-500 text-xs py-1 hover:bg-amber-500 hover:text-black rounded">-1</button>
                                    <button @click="modStat('pf', 1)" class="flex-1 bg-green-900/20 text-green-500 text-xs py-1 hover:bg-green-500 hover:text-black rounded">+1</button>
                                    <button @click="modStat('pf', 5)" class="px-2 bg-green-900/20 text-green-500 text-xs rounded hover:bg-green-500 hover:text-black font-bold">+5</button>
                                </div>
                            </div>
                            <!-- PDF -->
                            <div class="bg-black/40 p-3 rounded border border-white/5 hover:border-violet-500/30 transition-colors">
                                <div class="flex justify-between text-[10px] font-bold mb-1">
                                    <span class="text-violet-500">PDF (MENTE)</span>
                                    <div class="flex gap-1 text-white font-code">
                                        <span x-text="char.stats.pdf.current"></span> / 
                                        <input type="number" x-model="char.stats.pdf.max" @change="saveData()" class="bg-transparent w-10 text-right outline-none text-gray-400 focus:text-white border-b border-transparent focus:border-violet-500">
                                    </div>
                                </div>
                                <div class="h-1.5 bg-gray-800 rounded-full overflow-hidden"><div class="h-full bg-violet-500 transition-all" :style="`width:${Math.min(100, (char.stats.pdf.current/char.stats.pdf.max)*100)}%`"></div></div>
                                <div class="flex gap-1 mt-2">
                                    <button @click="modStat('pdf', -5)" class="px-2 bg-violet-900/20 text-violet-500 text-xs rounded hover:bg-violet-500 hover:text-black font-bold">-5</button>
                                    <button @click="modStat('pdf', -1)" class="flex-1 bg-violet-900/20 text-violet-500 text-xs py-1 hover:bg-violet-500 hover:text-black rounded">-1</button>
                                    <button @click="modStat('pdf', 1)" class="flex-1 bg-green-900/20 text-green-500 text-xs py-1 hover:bg-green-500 hover:text-black rounded">+1</button>
                                    <button @click="modStat('pdf', 5)" class="px-2 bg-green-900/20 text-green-500 text-xs rounded hover:bg-green-500 hover:text-black font-bold">+5</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: INFO & ATTRS -->
                <div class="lg:col-span-8 space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2"><input x-model="char.name" class="input-cyber w-full p-4 text-2xl font-light font-brand uppercase" placeholder="CODINOME"></div>
                        <div><input x-model="char.identity" class="input-cyber w-full p-3 text-sm" placeholder="IDENTIDADE REAL"></div>
                        <div><select x-model="char.class" @change="updateClassLogic()" class="input-cyber w-full p-3 text-sm"><option>Titã</option><option>Estrategista</option><option>Infiltrador</option><option>Controlador</option><option>Psíquico</option></select></div>
                    </div>

                    <!-- ATTR MATRIX -->
                    <div class="glass p-6 rounded-xl border border-white/5 flex flex-col md:flex-row items-center gap-8">
                        <div class="w-full md:w-1/2 space-y-2">
                            <template x-for="key in ['for','agi','int','von','pod']">
                                <div class="flex justify-between items-center bg-white/5 p-2 rounded border border-white/5">
                                    <span class="text-xs font-bold uppercase w-24" :class="{'text-rose-500':key=='for','text-emerald-500':key=='agi','text-cyan-500':key=='int','text-amber-500':key=='von','text-violet-500':key=='pod'}" x-text="key"></span>
                                    <div class="flex items-center gap-3">
                                        <button @click="modAttr(key, -1)" class="w-6 h-6 bg-black hover:bg-white/20 rounded flex items-center justify-center text-[10px]">-</button>
                                        <span class="font-mono font-bold text-lg w-6 text-center" x-text="char.attrs[key]"></span>
                                        <button @click="modAttr(key, 1)" class="w-6 h-6 bg-black hover:bg-white/20 rounded flex items-center justify-center text-[10px]">+</button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div class="w-full md:w-1/2 h-64 relative"><canvas id="radarChart"></canvas></div>
                    </div>

                    <!-- NEW: SKILLS (Perícias) -->
                    <div class="glass p-6 rounded-xl border-l-2 border-yellow-500">
                        <div class="flex justify-between mb-4 items-center">
                            <h3 class="text-xs font-bold text-yellow-500 uppercase">Perícias</h3>
                            <button @click="addSkill()" class="text-xs bg-white/5 hover:bg-white/10 px-2 py-1 rounded">ADD</button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <template x-for="(s, idx) in char.skills" :key="idx">
                                <div class="bg-black/40 p-3 rounded flex justify-between items-center">
                                    <input x-model="s.name" class="bg-transparent outline-none text-sm text-white w-1/2" placeholder="Nome da Perícia">
                                    <div class="flex gap-1">
                                        <template x-for="i in 5">
                                            <div @click="setSkillLevel(idx, i)" class="skill-dot" :class="i <= s.level ? 'active' : 'bg-black/50'"></div>
                                        </template>
                                    </div>
                                    <button @click="deleteSkill(idx)" class="ml-2 text-red-500 hover:text-red-400 text-xs"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- HISTORY -->
                    <div class="glass p-4 rounded-xl border-l-2 border-[var(--neon-core)]">
                        <label class="text-[10px] font-bold text-gray-500 uppercase mb-2 block">Arquivos Confidenciais</label>
                        <textarea x-model="char.history" class="w-full h-32 bg-transparent text-sm text-gray-300 resize-none outline-none font-code" placeholder="Registro de trauma..."></textarea>
                    </div>
                </div>
            </div>

            <!-- TAB LOGISTICS -->
            <div x-show="activeTab === 'logistics'" class="space-y-6">
                <div class="flex justify-between items-center"><h3 class="text-white font-brand">LOGÍSTICA</h3><div class="bg-black/40 px-4 py-2 rounded border border-white/10 flex items-center gap-2"><span class="text-amber-500">₵</span><input type="number" x-model="char.credits" class="bg-transparent w-24 text-right outline-none font-code"></div></div>

                <!-- SUB TABS -->
                <div class="flex gap-2 border-b border-white/10 pb-2 mb-4">
                    <button @click="logisticsTab = 'inventory'" :class="logisticsTab === 'inventory' ? 'text-[var(--neon-core)] border-b-2 border-[var(--neon-core)]' : 'text-gray-500'" class="px-3 py-1 text-xs font-bold uppercase transition-all">Inventário</button>
                    <button @click="logisticsTab = 'backpack'" :class="logisticsTab === 'backpack' ? 'text-[var(--neon-core)] border-b-2 border-[var(--neon-core)]' : 'text-gray-500'" class="px-3 py-1 text-xs font-bold uppercase transition-all">Mochila</button>
                    <button @click="logisticsTab = 'social'" :class="logisticsTab === 'social' ? 'text-[var(--neon-core)] border-b-2 border-[var(--neon-core)]' : 'text-gray-500'" class="px-3 py-1 text-xs font-bold uppercase transition-all">Social & Importantes</button>
                </div>

                <!-- INVENTORY VIEW -->
                <div x-show="logisticsTab === 'inventory'" class="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
                    <div class="glass p-4 rounded-lg">
                        <div class="flex justify-between mb-4 text-[var(--neon-alert)] font-bold text-xs uppercase tracking-widest"><span>Arsenal</span><button @click="addItem('weapons')" class="hover:text-white">ADD</button></div>
                        <div class="space-y-2 max-h-60 overflow-y-auto">
                            <template x-for="(w, i) in char.inventory.weapons" :key="i">
                                <div class="bg-black/40 p-2 rounded grid grid-cols-12 gap-2 items-center text-xs">
                                    <input x-model="w.name" class="col-span-5 bg-transparent outline-none font-bold text-white" placeholder="Nome">
                                    <input x-model="w.dmg" class="col-span-3 bg-transparent outline-none text-center text-gray-400" placeholder="Dano">
                                    <input x-model="w.range" class="col-span-3 bg-transparent outline-none text-center text-gray-400" placeholder="Alcance">
                                    <button @click="deleteItem('weapons', i)" class="col-span-1 text-red-500 text-right"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="glass p-4 rounded-lg">
                        <div class="flex justify-between mb-4 text-blue-400 font-bold text-xs uppercase tracking-widest"><span>Proteção</span><button @click="addItem('armor')" class="hover:text-white">ADD</button></div>
                        <div class="space-y-2 max-h-60 overflow-y-auto">
                            <template x-for="(a, i) in char.inventory.armor" :key="i">
                                <div class="bg-black/40 p-2 rounded grid grid-cols-12 gap-2 items-center text-xs">
                                    <input x-model="a.name" class="col-span-6 bg-transparent outline-none font-bold text-white" placeholder="Nome">
                                    <input x-model="a.def" class="col-span-3 bg-transparent outline-none text-center text-gray-400" placeholder="Def">
                                    <input x-model="a.pen" class="col-span-2 bg-transparent outline-none text-center text-gray-400" placeholder="Pen">
                                    <button @click="deleteItem('armor', i)" class="col-span-1 text-red-500 text-right"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- BACKPACK VIEW -->
                <div x-show="logisticsTab === 'backpack'" class="space-y-4 animate-fade-in">
                    <div class="glass p-4 rounded-lg">
                        <div class="flex justify-between mb-4 text-[var(--neon-success)] font-bold text-xs uppercase tracking-widest"><span>Suprimentos</span><button @click="addItem('gear')" class="hover:text-white">ADD</button></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-60 overflow-y-auto mb-4">
                            <template x-for="(g, i) in char.inventory.gear" :key="i">
                                <div class="bg-black/40 p-2 rounded flex justify-between items-center text-xs">
                                    <div class="flex-grow flex gap-2">
                                        <input x-model="g.name" class="bg-transparent outline-none font-bold text-white w-1/3" placeholder="Item">
                                        <input x-model="g.desc" class="bg-transparent outline-none text-gray-500 w-2/3" placeholder="Descrição">
                                    </div>
                                    <input x-model="g.qty" type="number" class="w-8 bg-transparent text-right outline-none text-[var(--neon-core)]">
                                    <button @click="deleteItem('gear', i)" class="ml-2 text-red-500"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                            </template>
                        </div>
                        <div class="border-t border-white/10 pt-4">
                            <label class="text-[10px] font-bold text-gray-500 uppercase mb-2 block">Outros Itens (Texto Livre)</label>
                            <textarea x-model="char.inventory.backpack" class="w-full h-32 bg-black/40 text-sm text-gray-300 p-3 rounded border border-white/5 focus:border-[var(--neon-core)] resize-none outline-none" placeholder="Cordas, rações, ferramentas..."></textarea>
                        </div>
                    </div>
                </div>

                <!-- SOCIAL VIEW -->
                <div x-show="logisticsTab === 'social'" class="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
                    <div class="glass p-4 rounded-lg">
                        <div class="flex justify-between mb-4 text-purple-400 font-bold text-xs uppercase tracking-widest"><span>Pessoas Importantes</span><button @click="addItem('social_people')" class="hover:text-white">ADD</button></div>
                        <div class="space-y-2">
                            <template x-for="(p, i) in char.inventory.social.people" :key="i">
                                <div class="bg-black/40 p-2 rounded flex justify-between items-center text-xs">
                                    <input x-model="p.name" class="bg-transparent outline-none font-bold text-white w-1/2" placeholder="Nome">
                                    <input x-model="p.role" class="bg-transparent outline-none text-gray-500 w-1/2" placeholder="Relação">
                                    <button @click="deleteItem('social', i, 'people')" class="ml-2 text-red-500"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="glass p-4 rounded-lg">
                        <div class="flex justify-between mb-4 text-yellow-400 font-bold text-xs uppercase tracking-widest"><span>Objetos Importantes</span><button @click="addItem('social_objects')" class="hover:text-white">ADD</button></div>
                        <div class="space-y-2">
                            <template x-for="(o, i) in char.inventory.social.objects" :key="i">
                                <div class="bg-black/40 p-2 rounded flex justify-between items-center text-xs">
                                    <input x-model="o.name" class="bg-transparent outline-none font-bold text-white w-1/2" placeholder="Objeto">
                                    <input x-model="o.desc" class="bg-transparent outline-none text-gray-500 w-1/2" placeholder="Detalhe">
                                    <button @click="deleteItem('social', i, 'objects')" class="ml-2 text-red-500"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB POWERS -->
            <div x-show="activeTab === 'powers'" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="glass p-4 rounded-lg"><h4 class="text-xs text-[var(--neon-core)] font-bold uppercase mb-2">Passiva</h4><textarea x-model="char.powers.passive" class="w-full h-24 bg-transparent resize-none outline-none text-sm text-gray-300"></textarea></div>
                    <div class="glass p-4 rounded-lg"><h4 class="text-xs text-[var(--neon-core)] font-bold uppercase mb-2">Ativa</h4><textarea x-model="char.powers.active" class="w-full h-24 bg-transparent resize-none outline-none text-sm text-gray-300"></textarea></div>
                </div>
                
                <!-- TECHNIQUES (CUSTOMIZABLE) -->
                <div class="glass p-6 rounded-xl border-l-2 border-emerald-500">
                    <div class="flex justify-between mb-4 items-center">
                        <h3 class="text-xs font-bold text-emerald-500 uppercase">Técnicas de Combate</h3>
                        <button @click="addTechnique()" class="text-xs bg-white/5 hover:bg-white/10 px-2 py-1 rounded">ADD</button>
                    </div>
                    <div class="space-y-3">
                        <template x-for="(t, idx) in char.powers.techniques" :key="idx">
                            <div class="bg-black/40 p-3 rounded">
                                <div class="flex justify-between mb-2">
                                    <input x-model="t.name" class="bg-transparent font-bold text-sm text-white w-full outline-none" placeholder="Nome da Técnica">
                                    <button @click="deleteTechnique(idx)" class="text-red-500 hover:text-red-400 text-xs"><i class="fa-solid fa-xmark"></i></button>
                                </div>
                                <textarea x-model="t.desc" class="w-full h-16 bg-transparent resize-none outline-none text-xs text-gray-400" placeholder="Descrição do efeito..."></textarea>
                            </div>
                        </template>
                    </div>
                </div>

                <div class="glass p-6 rounded-xl">
                    <h3 class="text-xs text-[var(--neon-purple)] font-bold uppercase mb-4 border-b border-white/10 pb-2">Trilha de Evolução</h3>
                    <div class="space-y-4">
                        <template x-for="lvl in [3,6,9,10]">
                            <div class="bg-black/20 p-3 rounded border border-white/5">
                                <div class="flex justify-between text-[10px] font-bold mb-1 text-gray-500"><span x-text="lvl===10?'LEGADO':'NÍVEL '+lvl"></span></div>
                                <textarea x-model="char.powers['lvl'+lvl]" class="w-full h-12 bg-transparent resize-none outline-none text-sm text-white" placeholder="Bloqueado..."></textarea>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </main>
    </template>

    <!-- DICE TRAY (ALWAYS FIXED) -->
    <div class="fixed bottom-0 left-0 w-full bg-black/90 backdrop-blur border-t border-[var(--neon-core)] p-3 z-50" x-show="currentView === 'sheet'">
        <div class="max-w-4xl mx-auto flex items-center justify-between gap-4">
            <div class="relative">
                <button @click="showDiceLog=!showDiceLog" class="text-gray-500 hover:text-white"><i class="fa-solid fa-list-ol"></i></button>
                <div x-show="showDiceLog" @click.outside="showDiceLog=false" class="absolute bottom-12 left-0 w-64 bg-[#0a0a0a] border border-white/20 rounded-lg p-3 shadow-2xl max-h-48 overflow-y-auto">
                    <template x-for="log in diceLog">
                        <div class="flex justify-between text-[10px] py-1 border-b border-white/5 text-gray-400 font-code">
                            <span x-text="log.time"></span>
                            <span x-text="log.formula"></span>
                            <span :class="log.crit?'text-[var(--neon-warn)]':log.fumble?'text-[var(--neon-alert)]':'text-white'" x-text="log.result"></span>
                        </div>
                    </template>
                </div>
            </div>
            <div class="flex gap-2 overflow-x-auto no-scrollbar">
                <div class="flex items-center bg-white/5 rounded px-2 mr-2 border border-white/10">
                    <span class="text-[8px] font-bold text-gray-500 mr-1">MOD</span>
                    <input type="number" x-model="diceMod" class="w-8 bg-transparent text-center text-sm font-bold text-[var(--neon-core)] outline-none">
                </div>
                <template x-for="d in [3,4,6,8,10,12,20,100]">
                    <button @click="roll(d)" class="w-9 h-9 rounded bg-white/5 border border-white/10 flex items-center justify-center text-[10px] font-bold hover:bg-[var(--neon-core)] hover:text-black hover:scale-110 transition-all" x-text="'D'+d"></button>
                </template>
            </div>
            <div class="min-w-[60px] text-center border-l border-white/10 pl-4">
                <div x-text="lastRoll" class="text-3xl font-bold font-brand" :class="lastNatural===lastFaces?'crit-success':lastNatural===1?'crit-fail':'text-white'">--</div>
            </div>
        </div>
    </div>

    <!-- WIZARD MODAL -->
    <div x-show="wizardOpen" class="fixed inset-0 z-[60] bg-black/95 backdrop-blur flex items-center justify-center p-4">
        <div class="w-full max-w-4xl h-[85vh] bg-[#050505] border border-[var(--neon-core)] rounded-2xl flex flex-col relative overflow-hidden shadow-2xl">
            <div class="p-6 border-b border-white/10 flex justify-between items-center">
                <h2 class="text-2xl font-brand text-white">NOVO AGENTE <span class="text-[var(--neon-core)] text-sm ml-2">INICIANDO...</span></h2>
                <button @click="wizardOpen=false" class="text-gray-500 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto p-6">
                <div x-show="wizardStep === 1">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <template x-for="arch in archetypes">
                            <div @click="selectArchetype(arch)" class="p-6 border border-white/10 rounded-xl hover:border-[var(--neon-core)] hover:bg-white/[0.02] cursor-pointer transition-all group text-center">
                                <i :class="arch.icon + ' text-4xl mb-4 ' + arch.color"></i>
                                <h3 class="text-xl font-bold text-white mb-2" x-text="arch.class"></h3>
                                <p class="text-xs text-gray-500 leading-relaxed" x-text="arch.desc"></p>
                                <div class="mt-4 pt-4 border-t border-white/5 text-[10px] font-code uppercase text-gray-400">FOCO: <span class="text-white" x-text="arch.focus"></span></div>
                            </div>
                        </template>
                    </div>
                </div>
                <div x-show="wizardStep === 2" class="flex flex-col h-full">
                    <div class="flex justify-between items-center mb-8 bg-white/5 p-4 rounded-lg">
                        <span class="text-2xl font-brand text-white" x-text="wizardData.class"></span>
                        <div class="text-right"><div class="text-[10px] text-gray-500">PONTOS</div><div class="text-3xl font-mono font-bold text-[var(--neon-success)]" x-text="wizardPoints"></div></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                        <div class="space-y-4">
                            <template x-for="key in ['for','agi','int','von','pod']">
                                <div class="flex items-center justify-between bg-black/40 p-3 rounded border border-white/5">
                                    <span class="uppercase font-bold text-xs w-12" :class="key===wizardFocusAttr?'text-[var(--neon-warn)]':'text-gray-400'" x-text="key"></span>
                                    <div class="flex items-center gap-3">
                                        <button @click="modWizardAttr(key, -1)" class="w-8 h-8 bg-white/5 hover:bg-white/10 rounded text-white disabled:opacity-20" :disabled="wizardData.attrs[key] <= (key===wizardFocusAttr?0:-1)">-</button>
                                        <span class="w-8 text-center font-mono font-bold text-lg" x-text="wizardData.attrs[key]"></span>
                                        <button @click="modWizardAttr(key, 1)" class="w-8 h-8 bg-[var(--neon-core)] text-black font-bold rounded hover:scale-105 disabled:opacity-50 disabled:bg-gray-700" :disabled="wizardData.attrs[key]>=3 || wizardPoints<=0">+</button>
                                    </div>
                                </div>
                            </template>
                        </div>
                        <div class="flex items-center justify-center bg-black/20 rounded-xl"><canvas id="wizChart"></canvas></div>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t border-white/10 bg-black/20 flex justify-between">
                <button x-show="wizardStep>1" @click="wizardStep--" class="px-6 py-2 border border-white/20 rounded text-xs font-bold hover:bg-white/5">VOLTAR</button>
                <div class="flex-grow"></div>
                <button x-show="wizardStep===2" @click="finishWizard()" class="px-8 py-2 bg-[var(--neon-success)] text-black font-bold rounded hover:scale-105 shadow-lg shadow-emerald-900/20">FINALIZAR</button>
            </div>
        </div>
    </div>

    <!-- CROPPER MODAL -->
    <div x-show="cropperOpen" class="fixed inset-0 z-[70] bg-black/95 flex items-center justify-center p-4">
        <div class="w-full max-w-lg h-[70vh] flex flex-col">
            <div class="flex-grow bg-[#111] relative rounded-lg overflow-hidden border border-white/10 mb-4"><img id="crop-target" class="block max-w-full"></div>
            <div class="flex gap-3">
                <input type="file" id="file-input" class="hidden" accept="image/*" @change="initCropper($event)">
                <button @click="document.getElementById('file-input').click()" class="flex-1 py-3 border border-white/20 rounded text-xs font-bold hover:bg-white/5">CARREGAR</button>
                <button @click="applyCrop()" class="flex-1 py-3 bg-[var(--neon-core)] text-black rounded text-xs font-bold">SALVAR</button>
                <button @click="cropperOpen=false" class="px-4 py-3 border border-red-500/30 text-red-500 rounded hover:bg-red-500/10"><i class="fa-solid fa-xmark"></i></button>
            </div>
        </div>
    </div>

    <!-- CONFIG MODAL -->
    <div x-show="configModal" class="fixed inset-0 z-[70] bg-black/90 backdrop-blur flex items-center justify-center">
        <div class="glass p-8 rounded-xl w-full max-w-md relative border border-white/10">
            <button @click="configModal=false" class="absolute top-4 right-4 text-gray-500 hover:text-white"><i class="fa-solid fa-xmark"></i></button>
            <h3 class="text-xl font-brand text-white mb-6">SISTEMA</h3>
            <div class="space-y-4">
                <button @click="exportData()" class="w-full py-3 bg-white/5 border border-white/10 rounded text-xs hover:bg-white/10 text-left px-4"><i class="fa-solid fa-download mr-3"></i>BACKUP (.JSON)</button>
                <div class="relative">
                    <input type="file" id="import-input" class="hidden" accept=".json" @change="importData($event)">
                    <button @click="document.getElementById('import-input').click()" class="w-full py-3 bg-white/5 border border-white/10 rounded text-xs hover:bg-white/10 text-left px-4"><i class="fa-solid fa-upload mr-3"></i>RESTAURAR</button>
                </div>
                <div class="border-t border-white/10 my-4"></div>
                <button @click="hardReset()" class="w-full py-3 border border-red-500/30 text-red-500 rounded text-xs hover:bg-red-500/10">HARD RESET</button>
            </div>
        </div>
    </div>

</body>
</html>
