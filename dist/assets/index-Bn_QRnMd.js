(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))s(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const n of r.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function i(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(a){if(a.ep)return;a.ep=!0;const r=i(a);fetch(a.href,r)}})();const F="modulepreload",B=function(e){return"/"+e},D={},V=function(t,i,s){let a=Promise.resolve();if(i&&i.length>0){let m=function(d){return Promise.all(d.map(v=>Promise.resolve(v).then(T=>({status:"fulfilled",value:T}),T=>({status:"rejected",reason:T}))))};var n=m;document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),h=c?.nonce||c?.getAttribute("nonce");a=m(i.map(d=>{if(d=B(d),d in D)return;D[d]=!0;const v=d.endsWith(".css"),T=v?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${T}`))return;const b=document.createElement("link");if(b.rel=v?"stylesheet":F,v||(b.as="script"),b.crossOrigin="",b.href=d,h&&b.setAttribute("nonce",h),document.head.appendChild(b),v)return new Promise((E,_)=>{b.addEventListener("load",E),b.addEventListener("error",()=>_(new Error(`Unable to preload CSS for ${d}`)))})}))}function r(c){const h=new Event("vite:preloadError",{cancelable:!0});if(h.payload=c,window.dispatchEvent(h),!h.defaultPrevented)throw c}return a.then(c=>{for(const h of c||[])h.status==="rejected"&&r(h.reason);return t().catch(r)})},L={MAX_AGENTS:30,SAVE_INTERVAL:18e4,SUPABASE_URL:"https://pwjoakajtygmbpezcrix.supabase.co",SUPABASE_KEY:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB3am9ha2FqdHlnbWJwZXpjcml4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxNTA4OTQsImV4cCI6MjA3OTcyNjg5NH0.92HNNPCaKccRLIV6HbP1CBFI7jL5ktt24Qh1tr-Md5E"},J={NETLINK_ENABLED:!0},j=[{class:"Titã",icon:"fa-solid fa-shield-halved",focus:"for",color:"text-rose-500",desc:"Resiliência e força bruta."},{class:"Estrategista",icon:"fa-solid fa-chess",focus:"int",color:"text-cyan-500",desc:"Análise tática e liderança."},{class:"Infiltrador",icon:"fa-solid fa-user-ninja",focus:"agi",color:"text-emerald-500",desc:"Furtividade e precisão."},{class:"Controlador",icon:"fa-solid fa-hand-spock",focus:"pod",color:"text-violet-500",desc:"Manipulação de energia."},{class:"Psíquico",icon:"fa-solid fa-brain",focus:"von",color:"text-amber-500",desc:"Domínio mental."}];let o=null,U=!0,u=null,M=null,w=null;const H=(e=1.5,t=2)=>{if(!o)return null;const i=o.sampleRate*e,s=o.createBuffer(2,i,o.sampleRate);for(let a=0;a<2;a++){const r=s.getChannelData(a);for(let n=0;n<i;n++)r[n]=(Math.random()*2-1)*Math.pow(1-n/i,t)}return s},z=()=>{if(!o)try{const e=window.AudioContext||window.webkitAudioContext;o=new e,w=o.createDynamicsCompressor(),w.threshold.value=-24,w.knee.value=30,w.ratio.value=12,w.attack.value=.003,w.release.value=.25,w.connect(o.destination),u=o.createGain(),u.gain.value=.7,u.connect(w),M=o.createConvolver(),M.buffer=H(1.2,2.5);const t=o.createGain();t.gain.value=.15,M.connect(t),t.connect(u)}catch{console.warn("[AUDIO] AudioContext não suportado")}},P=e=>{U=e,o&&(e&&o.state==="suspended"&&o.resume(),!e&&o.state==="running"&&o.suspend())},K=e=>{if(!o||!u)return;const t=o.currentTime,i=o.createOscillator(),s=o.createGain(),a=o.createBiquadFilter();e?(i.type="square",i.frequency.setValueAtTime(120,t),i.frequency.linearRampToValueAtTime(80,t+.08),a.type="highpass",a.frequency.setValueAtTime(800,t),s.gain.setValueAtTime(.12,t),s.gain.exponentialRampToValueAtTime(.001,t+.08)):(i.type="sine",i.frequency.setValueAtTime(2200,t),i.frequency.exponentialRampToValueAtTime(400,t+.03),a.type="bandpass",a.frequency.setValueAtTime(1500,t),a.Q.value=2,s.gain.setValueAtTime(0,t),s.gain.linearRampToValueAtTime(.15,t+.002),s.gain.exponentialRampToValueAtTime(.001,t+.05)),i.connect(a),a.connect(s),s.connect(u),i.start(t),i.stop(t+.1);const r=o.createOscillator(),n=o.createGain();r.type="sine",r.frequency.setValueAtTime(e?60:180,t),r.frequency.exponentialRampToValueAtTime(40,t+.06),n.gain.setValueAtTime(0,t),n.gain.linearRampToValueAtTime(e?.08:.1,t+.003),n.gain.exponentialRampToValueAtTime(.001,t+.06),r.connect(n),n.connect(u),r.start(t),r.stop(t+.08)},W=()=>{if(!o||!u)return;const e=o.currentTime,t=(i,s,a)=>{const r=o.createOscillator(),n=o.createGain(),c=o.createBiquadFilter();r.type="sine",r.frequency.setValueAtTime(i,e+s),c.type="lowpass",c.frequency.setValueAtTime(2e3,e+s),n.gain.setValueAtTime(0,e+s),n.gain.linearRampToValueAtTime(.12,e+s+.01),n.gain.exponentialRampToValueAtTime(.001,e+s+a),r.connect(c),c.connect(n),n.connect(u),r.start(e+s),r.stop(e+s+a)};t(523.25,0,.2),t(659.25,.08,.25),t(783.99,.16,.3)},Y=()=>{if(!o||!u)return;const e=o.currentTime,t=o.createOscillator(),i=o.createGain(),s=o.createBiquadFilter();t.type="triangle",t.frequency.setValueAtTime(280,e),t.frequency.exponentialRampToValueAtTime(180,e+.15),s.type="lowpass",s.frequency.setValueAtTime(800,e),i.gain.setValueAtTime(0,e),i.gain.linearRampToValueAtTime(.1,e+.01),i.gain.exponentialRampToValueAtTime(.001,e+.2),t.connect(s),s.connect(i),i.connect(u),t.start(e),t.stop(e+.25)},X=()=>{if(!o||!u)return;const e=o.currentTime,t=6+Math.floor(Math.random()*4);for(let i=0;i<t;i++){const s=i*.04+Math.random()*.02,a=800+Math.random()*400,r=o.createOscillator(),n=o.createGain();r.type="sine",r.frequency.setValueAtTime(a,e+s),r.frequency.exponentialRampToValueAtTime(200,e+s+.02),n.gain.setValueAtTime(0,e+s),n.gain.linearRampToValueAtTime(.06-i*.005,e+s+.002),n.gain.exponentialRampToValueAtTime(.001,e+s+.03),r.connect(n),n.connect(u),r.start(e+s),r.stop(e+s+.05)}setTimeout(()=>{if(!o||!u)return;const i=o.currentTime,s=o.createOscillator(),a=o.createGain();s.type="sine",s.frequency.setValueAtTime(600,i),s.frequency.exponentialRampToValueAtTime(150,i+.05),a.gain.setValueAtTime(.12,i),a.gain.exponentialRampToValueAtTime(.001,i+.08),s.connect(a),a.connect(u),s.start(i),s.stop(i+.1)},t*40+50)},Q=()=>{if(!o||!u)return;const e=o.currentTime;[523.25,659.25,783.99,1046.5].forEach((i,s)=>{const a=o.createOscillator(),r=o.createGain(),n=o.createBiquadFilter();a.type="sine",a.frequency.setValueAtTime(i,e+s*.06),n.type="lowpass",n.frequency.setValueAtTime(3e3,e),r.gain.setValueAtTime(0,e+s*.06),r.gain.linearRampToValueAtTime(.15,e+s*.06+.01),r.gain.exponentialRampToValueAtTime(.001,e+s*.06+.3),a.connect(n),n.connect(r),r.connect(u),a.start(e+s*.06),a.stop(e+s*.06+.35)})},Z=()=>{if(!o||!u)return;const e=o.currentTime,t=o.createOscillator(),i=o.createGain();t.type="triangle",t.frequency.setValueAtTime(400,e),t.frequency.exponentialRampToValueAtTime(100,e+.4),i.gain.setValueAtTime(.1,e),i.gain.exponentialRampToValueAtTime(.001,e+.5),t.connect(i),i.connect(u),t.start(e),t.stop(e+.6)},ee=()=>{if(!o||!u)return;const e=o.currentTime,t=o.createOscillator(),i=o.createGain();t.type="sine",t.frequency.setValueAtTime(880,e),t.frequency.setValueAtTime(1174.66,e+.1),i.gain.setValueAtTime(0,e),i.gain.linearRampToValueAtTime(.08,e+.01),i.gain.setValueAtTime(.08,e+.1),i.gain.exponentialRampToValueAtTime(.001,e+.25),t.connect(i),i.connect(u),t.start(e),t.stop(e+.3)},te=()=>{if(!o||!u)return;const e=o.currentTime,t=o.createOscillator(),i=o.createGain();t.type="sine",t.frequency.setValueAtTime(600,e),t.frequency.linearRampToValueAtTime(900,e+.12),i.gain.setValueAtTime(0,e),i.gain.linearRampToValueAtTime(.1,e+.01),i.gain.exponentialRampToValueAtTime(.001,e+.2),t.connect(i),i.connect(u),t.start(e),t.stop(e+.25);const s=o.createOscillator(),a=o.createGain();s.type="sine",s.frequency.setValueAtTime(1200,e+.05),a.gain.setValueAtTime(0,e+.05),a.gain.linearRampToValueAtTime(.04,e+.06),a.gain.exponentialRampToValueAtTime(.001,e+.2),s.connect(a),a.connect(u),s.start(e+.05),s.stop(e+.25)},ie=()=>{if(!o||!u)return;const e=o.currentTime;[{freq:261.63,delay:0,dur:.4},{freq:329.63,delay:.08,dur:.35},{freq:392,delay:.16,dur:.3},{freq:523.25,delay:.24,dur:.5},{freq:659.25,delay:.32,dur:.45},{freq:783.99,delay:.4,dur:.6},{freq:1046.5,delay:.48,dur:.8}].forEach(({freq:i,delay:s,dur:a})=>{const r=o.createOscillator(),n=o.createGain(),c=o.createBiquadFilter();r.type="sine",r.frequency.setValueAtTime(i,e+s),c.type="lowpass",c.frequency.setValueAtTime(4e3,e+s),c.Q.value=1;const h=s<.3?.12:.18;n.gain.setValueAtTime(0,e+s),n.gain.linearRampToValueAtTime(h,e+s+.015),n.gain.setValueAtTime(h*.9,e+s+a*.5),n.gain.exponentialRampToValueAtTime(.001,e+s+a),r.connect(c),c.connect(n),n.connect(u),M&&n.connect(M),r.start(e+s),r.stop(e+s+a+.1)});for(let i=0;i<5;i++){const s=o.createOscillator(),a=o.createGain();s.type="sine",s.frequency.setValueAtTime(2e3+Math.random()*1e3,e+.5+i*.05),a.gain.setValueAtTime(.03,e+.5+i*.05),a.gain.exponentialRampToValueAtTime(.001,e+.7+i*.05),s.connect(a),a.connect(u),s.start(e+.5+i*.05),s.stop(e+.8+i*.05)}},se=()=>{if(!o||!u)return;const e=o.currentTime,t=o.createOscillator(),i=o.createGain();t.type="sine",t.frequency.setValueAtTime(1800+Math.random()*200,e),i.gain.setValueAtTime(0,e),i.gain.linearRampToValueAtTime(.02,e+.005),i.gain.exponentialRampToValueAtTime(.001,e+.03),t.connect(i),i.connect(u),t.start(e),t.stop(e+.04)},ae=()=>{if(!o||!u)return;const e=o.currentTime,t=o.sampleRate*.3,i=o.createBuffer(1,t,o.sampleRate),s=i.getChannelData(0);for(let c=0;c<t;c++)s[c]=Math.random()*2-1;const a=o.createBufferSource();a.buffer=i;const r=o.createBiquadFilter();r.type="bandpass",r.frequency.setValueAtTime(200,e),r.frequency.exponentialRampToValueAtTime(2e3,e+.1),r.frequency.exponentialRampToValueAtTime(400,e+.2),r.Q.value=2;const n=o.createGain();n.gain.setValueAtTime(0,e),n.gain.linearRampToValueAtTime(.08,e+.05),n.gain.exponentialRampToValueAtTime(.001,e+.25),a.connect(r),r.connect(n),n.connect(u),a.start(e),a.stop(e+.3)},re=()=>{if(!o||!u)return;const e=o.currentTime;[1400,1800,2200].forEach((i,s)=>{const a=o.createOscillator(),r=o.createGain();a.type="sine",a.frequency.setValueAtTime(i,e+s*.02),a.frequency.exponentialRampToValueAtTime(i*.8,e+s*.02+.1),r.gain.setValueAtTime(0,e+s*.02),r.gain.linearRampToValueAtTime(.08-s*.02,e+s*.02+.005),r.gain.exponentialRampToValueAtTime(.001,e+s*.02+.15),a.connect(r),r.connect(u),a.start(e+s*.02),a.stop(e+s*.02+.2)})},ne=()=>{if(!o||!u)return;const e=o.currentTime;for(let t=0;t<4;t++){const i=o.createOscillator(),s=o.createGain(),a=o.createBiquadFilter(),r=400+t*200;i.type=t%2===0?"sine":"triangle",i.frequency.setValueAtTime(r,e+t*.03),i.frequency.linearRampToValueAtTime(r*1.5,e+t*.03+.2),a.type="bandpass",a.frequency.setValueAtTime(r*2,e+t*.03),a.Q.value=3,s.gain.setValueAtTime(0,e+t*.03),s.gain.linearRampToValueAtTime(.06,e+t*.03+.02),s.gain.exponentialRampToValueAtTime(.001,e+t*.03+.3),i.connect(a),a.connect(s),s.connect(u),M&&s.connect(M),i.start(e+t*.03),i.stop(e+t*.03+.35)}},oe=()=>{if(!o||!u)return;const e=o.currentTime,t=o.createOscillator(),i=o.createGain();t.type="sine",t.frequency.setValueAtTime(150,e),t.frequency.exponentialRampToValueAtTime(50,e+.1),i.gain.setValueAtTime(.2,e),i.gain.exponentialRampToValueAtTime(.001,e+.15),t.connect(i),i.connect(u),t.start(e),t.stop(e+.2);const s=o.createOscillator(),a=o.createGain();s.type="sawtooth",s.frequency.setValueAtTime(800,e),s.frequency.exponentialRampToValueAtTime(200,e+.03),a.gain.setValueAtTime(.1,e),a.gain.exponentialRampToValueAtTime(.001,e+.05),s.connect(a),a.connect(u),s.start(e),s.stop(e+.08)},ce=()=>{if(!o||!u)return;const e=o.currentTime,t=o.createOscillator(),i=o.createGain();t.type="sine",t.frequency.setValueAtTime(800,e),t.frequency.setValueAtTime(1e3,e+.03),i.gain.setValueAtTime(0,e),i.gain.linearRampToValueAtTime(.08,e+.005),i.gain.setValueAtTime(.08,e+.03),i.gain.exponentialRampToValueAtTime(.001,e+.08),t.connect(i),i.connect(u),t.start(e),t.stop(e+.1)},l=e=>{if(o||z(),!U||!o)return;o.state==="suspended"&&o.resume();const t=document.body.classList.contains("theme-hacker");try{switch(e){case"click":K(t);break;case"success":W();break;case"error":case"discard":Y();break;case"dice":X();break;case"critical":Q();break;case"fumble":Z();break;case"notification":ee();break;case"save":te();break;case"levelup":ie();break;case"hover":se();break;case"whoosh":ae();break;case"coin":re();break;case"magic":ne();break;case"combat":oe();break;case"toggle":ce();break}}catch{}},O=2.2;function le(e,t){let i;return function(...s){clearTimeout(i),i=setTimeout(()=>e.apply(this,s),t)}}function k(e){if(!e)return null;const t=JSON.parse(JSON.stringify(e));return t.attrs||(t.attrs={for:0,agi:0,int:0,von:0,pod:0}),t.stats||(t.stats={}),t.stats.pv||(t.stats.pv={current:10,max:10}),t.stats.pf||(t.stats.pf={current:10,max:10}),t.stats.pdf||(t.stats.pdf={current:10,max:10}),t.inventory||(t.inventory={weapons:[],armor:[],gear:[],backpack:"",social:{people:[],objects:[]}}),t.inventory.weapons||(t.inventory.weapons=[]),t.inventory.armor||(t.inventory.armor=[]),t.inventory.gear||(t.inventory.gear=[]),t.inventory.social||(t.inventory.social={people:[],objects:[]}),t.skills||(t.skills=[]),t.powers||(t.powers={passive:"",active:"",techniques:[],lvl3:"",lvl6:"",lvl9:"",lvl10:""}),t.powers.techniques||(t.powers.techniques=[]),t}function G(e,t,i){const s=e||"Titã",a=Math.max(1,parseInt(t)||1),r=h=>parseInt(i[h]||0),n={Titã:{pv:[15,4],pf:[12,2],pdf:[12,2]},Estrategista:{pv:[12,2],pf:[15,4],pdf:[12,2]},Infiltrador:{pv:[12,2],pf:[15,4],pdf:[12,3]},Controlador:{pv:[12,2],pf:[12,2],pdf:[15,4]},Psíquico:{pv:[12,2],pf:[13,3],pdf:[14,3]}},c=n[s]||n.Titã;return{pv:c.pv[0]+r("for")+(c.pv[1]+r("for"))*(a-1),pf:c.pf[0]+r("pod")+(c.pf[1]+r("pod"))*(a-1),pdf:c.pdf[0]+r("von")+(c.pdf[1]+r("von"))*(a-1)}}function he(){const e=new Date,t=e.getFullYear(),i=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),a=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0");return`${t}-${i}-${s}_${a}-${r}`}function q(e){if(!e)return null;const t=e.version||1;if(t>=O)return e;if(console.log(`[MIGRATION] Atualizando Agente ${e.name} da v${t} para v${O}`),e.lastAccess||(e.lastAccess=Date.now()),e.stats||(e.stats={pv:{},pf:{},pdf:{}}),["pv","pf","pdf"].forEach(i=>{e.stats[i]||(e.stats[i]={current:0,max:0})}),e.inventory?(e.inventory.weapons||(e.inventory.weapons=[]),e.inventory.armor||(e.inventory.armor=[]),e.inventory.gear||(e.inventory.gear=[]),typeof e.inventory.backpack>"u"&&(e.inventory.backpack=""),e.inventory.social?(e.inventory.social.people||(e.inventory.social.people=[]),e.inventory.social.objects||(e.inventory.social.objects=[])):e.inventory.social={people:[],objects:[]}):e.inventory={weapons:[],armor:[],gear:[],backpack:"",social:{people:[],objects:[]}},!e.attrs)e.attrs={for:0,agi:0,int:0,von:0,pod:0};else{const i={for:0,agi:0,int:0,von:0,pod:0};e.attrs={...i,...e.attrs}}return e.skills||(e.skills=[]),e.powers||(e.powers={passive:"",active:"",techniques:[]}),e.powers.techniques||(e.powers.techniques=[]),e.version=O,e}const ue={recalcDerivedStats(){if(!this.char)return;this.char.stats||(this.char.stats={pv:{current:0,max:0},pf:{current:0,max:0},pdf:{current:0,max:0}});const e=G(this.char.class,this.char.level,this.char.attrs),t=this.char,i=(n,c)=>n&&n[c]!==void 0?n[c]:0,s=(i(t.stats.pv,"max")||e.pv)-i(t.stats.pv,"current"),a=(i(t.stats.pf,"max")||e.pf)-i(t.stats.pf,"current"),r=(i(t.stats.pdf,"max")||e.pdf)-i(t.stats.pdf,"current");t.stats.pv.max=e.pv,t.stats.pv.current=Math.max(0,e.pv-s),t.stats.pf.max=e.pf,t.stats.pf.current=Math.max(0,e.pf-a),t.stats.pdf.max=e.pdf,t.stats.pdf.current=Math.max(0,e.pdf-r)},modAttr(e,t){const i=this.char;i.attrs||(i.attrs={for:0,agi:0,int:0,von:0,pod:0}),(t>0&&i.attrs[e]<6||t<0&&i.attrs[e]>-1)&&(i.attrs[e]+=t,this.recalcDerivedStats(),this.updateRadarChart())},modStat(e,t){if(!this.char||!this.char.stats[e])return;const i=this.char.stats[e];i.current=Math.max(0,Math.min(i.max,i.current+t))},addItem(e){const t={weapons:{name:"Arma",dmg:"1d6",range:"C"},armor:{name:"Traje",def:"1",pen:"0"},gear:{name:"Item",desc:"",qty:1},social_people:{name:"Nome",role:"Relação"},social_objects:{name:"Objeto",desc:"Detalhes"}};e.startsWith("social_")?this.char.inventory.social[e.split("_")[1]].push({...t[e]}):this.char.inventory[e].push({...t[e]})},deleteItem(e,t,i=null){i?this.char.inventory.social[i].splice(t,1):this.char.inventory[e].splice(t,1)},addSkill(){this.char.skills.push({name:"Nova Perícia",level:1})},deleteSkill(e){this.char.skills.splice(e,1)},setSkillLevel(e,t){this.char.skills[e].level=t},addTechnique(){this.char.powers.techniques.push({name:"Técnica",desc:""})},deleteTechnique(e){this.char.powers.techniques.splice(e,1)},cryptoRandom(e){const t=Math.floor(4294967295/e)*e;let i;do{const s=new Uint32Array(1);window.crypto.getRandomValues(s),i=s[0]}while(i>=t);return i%e+1},roll(e){l("dice");const t=this.cryptoRandom(e),i=parseInt(this.diceMod||0);this.lastNatural=t,this.lastFaces=e,this.lastRoll=t+i,setTimeout(()=>{t===e?l("critical"):t===1&&l("fumble")},400);let s=`D${e}`;i!==0&&(s+=i>0?`+${i}`:`${i}`);const a=new Date,r={id:Date.now(),timestamp:a.getTime(),date:a.toLocaleDateString("pt-BR"),time:a.toLocaleTimeString("pt-BR"),formula:s,result:t+i,natural:t,mod:i,crit:t===e,fumble:t===1,reason:this.diceReason||""};this.diceLog.unshift(r),this.diceReason="",this.saveDiceHistory()},getDiceLogStorageKey(){return this.activeCampaign?.id?`zenite_dice_log_campaign_${this.activeCampaign.id}`:"zenite_dice_log_local"},saveDiceHistory(){const e=this.isMobile?20:100;this.diceLog.length>e&&(this.diceLog=this.diceLog.slice(0,e));try{const t=this.getDiceLogStorageKey();localStorage.setItem(t,JSON.stringify(this.diceLog))}catch{console.warn("Erro ao salvar histórico de dados")}},loadDiceHistory(){const e=this.getDiceLogStorageKey(),t=localStorage.getItem(e);if(t)try{const i=JSON.parse(t),s=Date.now(),a=336*60*60*1e3;this.diceLog=i.filter(r=>s-r.timestamp<a),this.diceLog=this.diceLog.map(r=>{if(!r.date&&r.timestamp){const n=new Date(r.timestamp);r.date=n.toLocaleDateString("pt-BR"),r.time=n.toLocaleTimeString("pt-BR")}return r}),this.diceLog.length<i.length&&this.saveDiceHistory()}catch{this.diceLog=[]}else this.diceLog=[]},switchDiceLogContext(){this.loadDiceHistory()}},de={loadLocal(e){const t=localStorage.getItem(e);if(t)try{const i=JSON.parse(t);i.config&&(this.settings={...this.settings,...i.config}),i.trayPos&&(this.trayPosition=i.trayPos),i.hasSeenTip!==void 0&&(this.hasSeenDiceTip=i.hasSeenTip),i.trayDockMode&&(this.trayDockMode=i.trayDockMode);const s=4320*60*60*1e3,a=Date.now();let r=0;const n={},c=["config","trayPos","hasSeenTip","trayDockMode"];Object.keys(i).forEach(h=>{if(!c.includes(h)&&i[h]?.id){let m=k(i[h]);m=q(m);const d=m.lastAccess||a;a-d<s?n[h]=m:r++}}),r>0&&this.notify(`${r} fichas antigas removidas.`,"info"),this.chars=n,this.updateAgentCount()}catch(i){console.error("Local Load Error:",i),this.notify("Erro ao carregar dados locais.","error")}},saveLocal(){try{const e=this.isGuest?"zenite_guest_db":"zenite_cached_db",t={...this.chars,config:this.settings,trayPos:this.trayPosition,trayDockMode:this.trayDockMode,hasSeenTip:this.hasSeenDiceTip};localStorage.setItem(e,JSON.stringify(t))}catch(e){console.error("Save Local Error:",e),e.name==="QuotaExceededError"&&this.notify("Armazenamento local cheio. Limpe o cache.","error")}},async fetchCloud(){if(!(!this.user||!this.supabase))try{let{data:e,error:t}=await this.supabase.from("profiles").select("data").eq("id",this.user.id).single();if(t&&t.code==="PGRST116"){console.log("[CLOUD] Criando novo perfil para usuário:",this.user.id);const{error:i}=await this.supabase.from("profiles").insert([{id:this.user.id,data:{config:this.settings}}]);if(i){console.error("[CLOUD] Erro ao criar perfil:",i),this.notify("Erro ao criar perfil na nuvem.","error");return}e={data:{config:this.settings}}}else if(t){console.error("[CLOUD] Erro ao buscar dados:",t),this.notify("Erro ao buscar dados da nuvem.","error");return}if(e&&e.data){const i=e.data,s=["config","hasSeenTip","trayDockMode"];i.config&&(this.settings={...this.settings,...i.config},this.applyTheme(this.settings.themeColor)),i.hasSeenTip!==void 0&&(this.hasSeenDiceTip=i.hasSeenTip);let a={};Object.keys(i).forEach(r=>{if(!s.includes(r)&&i[r]?.id){let n=k(i[r]);n=q(n),n.lastAccess||(n.lastAccess=Date.now()),a[r]=n}}),this.chars=a,this.updateAgentCount(),this.saveLocal(),console.log("[CLOUD] Dados sincronizados:",Object.keys(a).length,"personagens")}}catch(e){console.error("[CLOUD] Fetch Error:",e),this.notify("Erro de conexão com a nuvem.","error")}},async syncCloud(e=!1){if(!(!this.user||this.isGuest||!this.supabase)){if(this.isSyncing){console.log("[CLOUD] Sincronização já em andamento, ignorando...");return}this.isSyncing=!0,e||this.notify("Sincronizando...","info");try{const t={...this.chars,config:this.settings,hasSeenTip:this.hasSeenDiceTip},i=JSON.stringify(t).length;i>9e5&&(console.warn("[CLOUD] Payload muito grande:",i,"bytes"),this.notify("Dados muito grandes. Remova personagens antigos.","warn"));const{error:s}=await this.supabase.from("profiles").upsert({id:this.user.id,data:t,updated_at:new Date().toISOString()},{onConflict:"id"});if(s)throw console.error("[CLOUD] Sync Error:",s),s;this.unsavedChanges=!1,this.saveStatus="success",this.lastManualSave=new Date,console.log("[CLOUD] Sincronização bem-sucedida"),e||(this.notify("Salvo na nuvem!","success"),l("save"))}catch(t){console.error("[CLOUD] Sync Exception:",t),this.saveStatus="error";let i="Erro ao salvar na nuvem.";t.message?.includes("JWT")?i="Sessão expirada. Faça login novamente.":t.message?.includes("network")&&(i="Sem conexão com a internet."),e||this.notify(i,"error")}finally{this.isSyncing=!1}}},async forceSyncCloud(){if(!(!this.user||this.isGuest||!this.supabase)){this.notify("Forçando sincronização...","info"),this.isSyncing=!0;try{await this.fetchCloud(),await this.syncCloud(!1),this.notify("Sincronização completa!","success")}catch(e){console.error("Force Sync Error:",e),this.notify("Erro na sincronização forçada.","error")}finally{this.isSyncing=!1}}},updateAgentCount(){this.agentCount=Object.keys(this.chars).length},askLogout(){this.askConfirm("ENCERRAR SESSÃO?","Dados pendentes serão salvos antes de sair.","warn",()=>this.logout())},async logout(){console.log("[CLOUD] Iniciando logout..."),this.systemLoading=!0;try{if(!this.isGuest&&this.supabase)try{await Promise.race([this.syncCloud(!0),new Promise((e,t)=>setTimeout(()=>t(new Error("Timeout")),3e3))]),console.log("[CLOUD] Dados salvos antes do logout")}catch(e){console.warn("[CLOUD] Erro ao salvar no logout (continuando mesmo assim):",e)}if(this.saveLocal(),this.disconnectRealtime)try{await this.disconnectRealtime()}catch(e){console.warn("[CLOUD] Erro ao desconectar realtime:",e)}if(this.supabase)try{await this.supabase.auth.signOut(),console.log("[CLOUD] Deslogado do Supabase")}catch(e){console.error("[CLOUD] Erro no Supabase SignOut (limpando mesmo assim):",e)}}finally{console.log("[CLOUD] Limpando estado..."),localStorage.removeItem("zenite_is_guest"),this.user=null,this.isGuest=!1,this.activeCampaign=null,this.campaignMembers=[],this.realtimeChannel=null,this.currentView="login",window.history.replaceState({route:"login"},"","/"),document.title="ZENITE OS // Login",this.systemLoading=!1,this.notify("Sessão encerrada.","success"),console.log("[CLOUD] Logout completo")}},askSwitchToOnline(){this.askConfirm("CONECTAR À NUVEM?","Seus dados locais serão sincronizados.","info",()=>{this.isGuest=!1,localStorage.removeItem("zenite_is_guest"),window.location.reload()})},enterGuest(){this.isGuest=!0,localStorage.setItem("zenite_is_guest","true"),this.loadLocal("zenite_guest_db"),this.currentView="dashboard",window.history.replaceState({route:"dashboard"},"","/")},async signUpWithEmail(e=null,t=null,i=null){e=e||this.authEmail,t=t||this.authPassword,i=i||this.authUsername;const s=this.authPasswordConfirm;if(!this.supabase)return this.notify("Erro de conexão com servidor.","error");if(!e||!t)return this.notify("Email e senha são obrigatórios.","error");if(t.length<6)return this.notify("Senha deve ter pelo menos 6 caracteres.","error");if(t!==s)return this.notify("As senhas não coincidem.","error");if(!i||i.length<2)return this.notify("Username deve ter pelo menos 2 caracteres.","error");try{const{data:a}=await this.supabase.rpc("check_email_oauth_provider",{email_to_check:e});if(a?.exists){const r=a.provider;if(r==="google"){this.authMsg="Este email já está cadastrado com Google. Use 'Continuar com Google'.",this.authMsgType="error",this.notify(this.authMsg,"error");return}else if(r==="discord"){this.authMsg="Este email já está cadastrado com Discord. Use 'Continuar com Discord'.",this.authMsgType="error",this.notify(this.authMsg,"error");return}}}catch(a){console.warn("[CLOUD] Não foi possível verificar OAuth provider:",a)}this.authLoading=!0,this.authMsg="Criando conta...",this.authMsgType="info";try{const{data:a,error:r}=await this.supabase.auth.signUp({email:e,password:t,options:{data:{username:i||e.split("@")[0]}}});if(r)throw r;a.user&&!a.session?(this.authMsg="Verifique seu email para confirmar a conta!",this.authMsgType="success",this.notify("Email de confirmação enviado!","success")):a.session&&(this.user=a.user,this.isGuest=!1,localStorage.removeItem("zenite_is_guest"),this.authMsg="Conta criada com sucesso!",this.authMsgType="success",this.notify("Bem-vindo ao ZENITE!","success"),await this.fetchCloud(),this.checkOnboarding(),this.checkUsername(),this.currentView="dashboard",window.history.replaceState({route:"dashboard"},"","/"))}catch(a){console.error("[CLOUD] Erro no registro:",a),this.authMsg=this.translateAuthError(a.message),this.authMsgType="error",this.notify(this.authMsg,"error")}finally{this.authLoading=!1}},async signInWithEmail(e=null,t=null){if(e=e||this.authEmail,t=t||this.authPassword,!this.supabase)return this.notify("Erro de conexão com servidor.","error");if(!e||!t)return this.notify("Email e senha são obrigatórios.","error");try{const{data:i}=await this.supabase.rpc("check_email_oauth_provider",{email_to_check:e});if(i?.exists&&!i?.can_login_with_password){const s=i.provider;if(s==="google"){this.authMsg="Este email usa login com Google.",this.authMsgType="error",this.notify("Use 'Continuar com Google' para entrar.","error");return}else if(s==="discord"){this.authMsg="Este email usa login com Discord.",this.authMsgType="error",this.notify("Use 'Continuar com Discord' para entrar.","error");return}}}catch(i){console.warn("[CLOUD] Não foi possível verificar OAuth provider:",i)}this.authLoading=!0,this.authMsg="Entrando...",this.authMsgType="info";try{const{data:i,error:s}=await this.supabase.auth.signInWithPassword({email:e,password:t});if(s)throw s;this.user=i.user,this.isGuest=!1,localStorage.removeItem("zenite_is_guest"),this.authMsg="Login realizado!",this.authMsgType="success",this.notify("Bem-vindo de volta!","success"),await this.fetchCloud(),this.checkOnboarding(),this.checkUsername(),this.currentView="dashboard",window.history.replaceState({route:"dashboard"},"","/")}catch(i){console.error("[CLOUD] Erro no login:",i),this.authMsg=this.translateAuthError(i.message),this.authMsgType="error",this.notify(this.authMsg,"error")}finally{this.authLoading=!1}},async resetPassword(e=null){if(e=e||this.authEmail,!this.supabase)return this.notify("Erro de conexão com servidor.","error");if(!e)return this.notify("Digite seu email.","error");try{const{data:t}=await this.supabase.rpc("check_email_oauth_provider",{email_to_check:e});if(t?.exists&&!t?.can_login_with_password){const i=t.provider;if(i==="google"){this.authMsg="Este email usa login com Google. Não é possível recuperar senha.",this.authMsgType="error",this.notify(this.authMsg,"error");return}else if(i==="discord"){this.authMsg="Este email usa login com Discord. Não é possível recuperar senha.",this.authMsgType="error",this.notify(this.authMsg,"error");return}}}catch(t){console.warn("[CLOUD] Não foi possível verificar OAuth provider:",t)}this.authLoading=!0,this.authMsg="Enviando email...";try{const{error:t}=await this.supabase.auth.resetPasswordForEmail(e,{redirectTo:`${window.location.origin}/reset-password`});if(t)throw t;this.authMsg="Email de recuperação enviado!",this.authMsgType="success",this.notify("Verifique sua caixa de entrada.","success")}catch(t){console.error("[CLOUD] Erro ao recuperar senha:",t),this.authMsg=this.translateAuthError(t.message),this.authMsgType="error"}finally{this.authLoading=!1}},translateAuthError(e){return{"Invalid login credentials":"Email ou senha incorretos","Email not confirmed":"Email não confirmado. Verifique sua caixa de entrada.","User already registered":"Este email já está cadastrado","Password should be at least 6 characters":"Senha deve ter pelo menos 6 caracteres","Unable to validate email address: invalid format":"Formato de email inválido","Email rate limit exceeded":"Muitas tentativas. Aguarde alguns minutos.","For security purposes, you can only request this once every 60 seconds":"Aguarde 60 segundos para tentar novamente"}[e]||e},doSocialAuth(e){if(!this.supabase)return this.notify("Erro de conexão com servidor.","error");this.authLoading=!0,this.authMsg="Conectando...",this.supabase.auth.signInWithOAuth({provider:e,options:{redirectTo:window.location.origin}}).then(({error:t})=>{t&&(this.notify(t.message,"error"),this.authLoading=!1)})}},me={toggleSetting(e,t=null){t!==null?(this.settings[e]=t,e==="themeColor"&&(this.applyTheme(t),this.incrementStat&&this.incrementStat("themeChanges"))):this.settings[e]=!this.settings[e],e==="compactMode"&&this.applyCompactMode(),this.updateVisualState(),this.saveLocal()},applyCompactMode(){this.isMobile&&this.settings.compactMode?(document.body.classList.add("compact-mode"),document.documentElement.style.setProperty("--compact-scale","0.9")):(document.body.classList.remove("compact-mode"),document.documentElement.style.removeProperty("--compact-scale"))},applyTheme(e){const t=document.documentElement,i={cyan:"#0ea5e9",purple:"#d946ef",gold:"#eab308",red:"#ef4444",green:"#22c55e",orange:"#f97316",pink:"#ec4899",lime:"#84cc16",emerald:"#10b981",violet:"#8b5cf6",rose:"#f43f5e",amber:"#f59e0b",teal:"#14b8a6",indigo:"#6366f1",fuchsia:"#d946ef",sky:"#0ea5e9"},s=i[e]||i.cyan,a=parseInt(s.slice(1,3),16),r=parseInt(s.slice(3,5),16),n=parseInt(s.slice(5,7),16);t.style.setProperty("--neon-core",s),t.style.setProperty("--neon-rgb",`${a}, ${r}, ${n}`)},getThemeColors(){return[{id:"cyan",name:"Ciano",hex:"#0ea5e9"},{id:"purple",name:"Roxo",hex:"#d946ef"},{id:"gold",name:"Dourado",hex:"#eab308"},{id:"red",name:"Vermelho",hex:"#ef4444"},{id:"green",name:"Verde",hex:"#22c55e"},{id:"orange",name:"Laranja",hex:"#f97316"},{id:"pink",name:"Rosa",hex:"#ec4899"},{id:"lime",name:"Lima",hex:"#84cc16"},{id:"emerald",name:"Esmeralda",hex:"#10b981"},{id:"violet",name:"Violeta",hex:"#8b5cf6"},{id:"rose",name:"Rosé",hex:"#f43f5e"},{id:"amber",name:"Âmbar",hex:"#f59e0b"},{id:"teal",name:"Azul-Verde",hex:"#14b8a6"},{id:"indigo",name:"Índigo",hex:"#6366f1"}]},updateVisualState(){(this.user||this.isGuest)&&this.settings.crtMode?document.body.classList.add("crt-mode"):document.body.classList.remove("crt-mode"),localStorage.getItem("zenite_hacker_mode")==="true"&&(this.isHackerMode=!0,document.body.classList.add("theme-hacker"))},openWizard(){if(this.agentCount>=L.MAX_AGENTS)return this.notify("Limite de 30 agentes atingido.","error");this.wizardStep=1,this.wizardPoints=8,this.wizardData={class:"",name:"",identity:"",age:"",history:"",photo:null,attrs:{for:-1,agi:-1,int:-1,von:-1,pod:-1}},this.wizardOpen=!0},selectArchetype(e){this.wizardData.class=e.class,this.wizardData.attrs={for:-1,agi:-1,int:-1,von:-1,pod:-1},this.wizardData.attrs[e.focus]=0,this.wizardFocusAttr=e.focus,this.wizardPoints=8,this.wizardStep=2,this.$nextTick(()=>{this.updateWizardChart()})},modWizardAttr(e,t){const i=this.wizardData.attrs[e],s=e===this.wizardFocusAttr;t>0&&this.wizardPoints>0&&i<3&&(this.wizardData.attrs[e]++,this.wizardPoints--,this.updateWizardChart()),t<0&&i>(s?0:-1)&&(this.wizardData.attrs[e]--,this.wizardPoints++,this.updateWizardChart())},finishWizard(){if(!this.wizardData.name){this.wizardNameError=!0,this.notify("Codinome obrigatório!","warn"),l("error"),setTimeout(()=>{this.wizardNameError=!1},500);return}const e="z_"+Date.now(),t=G(this.wizardData.class,1,this.wizardData.attrs),i=k({id:e,name:this.wizardData.name,identity:this.wizardData.identity,class:this.wizardData.class,level:1,age:this.wizardData.age,photo:this.wizardData.photo||"",history:this.wizardData.history,attrs:{...this.wizardData.attrs},stats:{pv:{current:t.pv,max:t.pv},pf:{current:t.pf,max:t.pf},pdf:{current:t.pdf,max:t.pdf}}});this.chars[e]=i,this.updateAgentCount(),this.saveLocal(),this.isGuest||(this.unsavedChanges=!0,this.autoSaveEnabled=!0,this.debouncedSaveFunc()),this.wizardOpen=!1,this.wizardFromNetlink?(this.wizardFromNetlink=!1,this.netlinkModal=!0,this.loadCampaigns(),this.notify("Personagem criado! Agora selecione-o para entrar na campanha.","success")):(this.loadCharacter(e),this.notify("Agente inicializado com sucesso!","success"))},loadCharacter(e,t=!1){if(!this.chars[e])return this.notify("Erro ao carregar personagem.","error");t||history.pushState({view:"sheet",id:e},"Ficha","#sheet"),this.loadingChar=!0,this.activeCharId=e,this.diceTrayOpen=!1,this.userMenuOpen=!1,requestAnimationFrame(()=>{this.char=k(this.chars[e]),this.currentView="sheet",this.activeTab="profile",this.hasSeenDiceTip||setTimeout(()=>this.showDiceTip=!0,2e3),this.$nextTick(()=>{this.updateRadarChart(),setTimeout(()=>{this.loadingChar=!1,this.unsavedChanges=!1},300)})})},askDeleteChar(e){const t=this.chars[e]?.name||"este personagem";this.askConfirm("ELIMINAR PERMANENTEMENTE?",`"${t}" será deletado para sempre. Esta ação é irreversível.`,"danger",async()=>{this.activeCharId===e&&(this.activeCharId=null,this.char=null,this.currentView="dashboard",await new Promise(s=>setTimeout(s,50))),delete this.chars[e],this.saveLocal(),!this.isGuest&&this.user&&(this.unsavedChanges=!0,await this.syncCloud(!1)),this.updateAgentCount(),this.notify("Personagem eliminado.","success")})},askHardReset(){this.askConfirm("LIMPAR CACHE LOCAL?","Remove TODOS os dados salvos localmente. Use apenas se houver problemas graves.","danger",()=>{localStorage.clear(),window.location.reload()})},askConfirm(e,t,i,s){this.confirmData={title:e,desc:t,type:i,action:s},this.confirmOpen=!0},confirmYes(){this.confirmData.action&&this.confirmData.action(),this.confirmOpen=!1},toggleRevertMode(){this.revertConfirmMode=!this.revertConfirmMode,this.revertConfirmMode&&(this.diceTrayOpen=!1)},async performRevert(){this.isReverting=!0,this.diceTrayOpen=!1,this.revertConfirmMode=!1,document.body.classList.add("animating-out"),document.body.classList.add("interaction-lock"),l("discard"),setTimeout(async()=>{try{this.isGuest?this.loadLocal("zenite_guest_db"):(this.loadLocal("zenite_cached_db"),await this.fetchCloud()),this.activeCharId&&this.chars[this.activeCharId]?this.char=k(this.chars[this.activeCharId]):(this.currentView="dashboard",this.char=null),this.unsavedChanges=!1,document.body.classList.remove("animating-out"),document.body.classList.add("animating-in"),this.notify("Alterações descartadas.","success"),setTimeout(()=>{document.body.classList.remove("animating-in"),document.body.classList.remove("interaction-lock"),this.isReverting=!1,this.unsavedChanges=!1},400)}catch(e){console.error("Revert Error:",e),this.notify("Erro ao descartar alterações.","error"),document.body.classList.remove("animating-out"),document.body.classList.remove("interaction-lock"),this.isReverting=!1}},300)},triggerShake(){this.shakeAlert=!0,l("error"),setTimeout(()=>this.shakeAlert=!1,300)},attemptGoBack(){if(this.unsavedChanges&&!this.isGuest){this.triggerShake(),this.notify("Salve ou descarte as alterações antes de sair.","warn");return}this.saveAndExit()},saveAndExit(e=!1){if(this.unsavedChanges&&!this.isGuest&&!e){this.triggerShake();return}this.char&&this.activeCharId&&(this.chars[this.activeCharId]=JSON.parse(JSON.stringify(this.char)),this.updateAgentCount()),this.saveLocal(),!this.isGuest&&this.unsavedChanges&&(this.autoSaveEnabled=!0,this.debouncedSaveFunc()),this.diceTrayOpen=!1,this.showDiceTip=!1,this.userMenuOpen=!1,this.currentView="dashboard",this.activeCharId=null,!e&&window.location.hash==="#sheet"&&history.back()},_renderChart(e,t,i=!1){const s=document.getElementById(e);if(!s)return;const a=getComputedStyle(document.documentElement).getPropertyValue("--neon-core").trim(),r=parseInt(a.slice(1,3),16),n=parseInt(a.slice(3,5),16),c=parseInt(a.slice(5,7),16),h=`${r},${n},${c}`;s.chart?(s.chart.data.datasets[0].data=t,s.chart.data.datasets[0].backgroundColor=`rgba(${h}, 0.2)`,s.chart.data.datasets[0].borderColor=`rgba(${h}, 1)`,s.chart.update()):s.chart=new Chart(s,{type:"radar",data:{labels:["FOR","AGI","INT","VON","POD"],datasets:[{data:t,backgroundColor:`rgba(${h}, 0.2)`,borderColor:`rgba(${h}, 1)`,borderWidth:2,pointBackgroundColor:"#fff",pointRadius:i?4:3}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{r:{min:-1,max:i?4:6,ticks:{display:!1,stepSize:1},grid:{color:"rgba(255,255,255,0.1)",circular:!1},angleLines:{color:"rgba(255,255,255,0.1)"}}},plugins:{legend:{display:!1}},transitions:{active:{animation:{duration:600}}}}})},updateRadarChart(){if(!this.char||!this.char.attrs)return;const e=[this.char.attrs.for,this.char.attrs.agi,this.char.attrs.int,this.char.attrs.von,this.char.attrs.pod];this._renderChart("radarChart",e)},updateWizardChart(){const e=[this.wizardData.attrs.for,this.wizardData.attrs.agi,this.wizardData.attrs.int,this.wizardData.attrs.von,this.wizardData.attrs.pod];this._renderChart("wizChart",e,!0)},openImageEditor(e="sheet"){this.uploadContext=e,document.getElementById("file-input").click()},initCropper(e){const t=e.target.files[0];if(!t)return;const i=new FileReader;i.onload=s=>{const a=document.getElementById("crop-target");a&&(a.src=s.target.result,this.cropperOpen=!0,setTimeout(()=>{this.cropperInstance&&this.cropperInstance.destroy(),this.cropperInstance=new Cropper(a,{aspectRatio:1,viewMode:1})},150))},i.readAsDataURL(t),e.target.value=""},applyCrop(){if(!this.cropperInstance)return;const e=this.cropperInstance.getCroppedCanvas({width:300,height:300}).toDataURL("image/jpeg",.8);this.uploadContext==="wizard"?this.wizardData.photo=e:this.char&&(this.char.photo=e),this.cropperOpen=!1,this.notify("Foto atualizada.","success")},exportData(){const e=he(),t=this.user?.email||"guest",s=`zenite_backup_${t.split("@")[0]}_${e}.json`,a={version:"2.2",exported:new Date().toISOString(),user:t,chars:this.chars,settings:this.settings},r=JSON.stringify(a,null,2),n=new Blob([r],{type:"application/json"}),c=URL.createObjectURL(n),h=document.createElement("a");h.href=c,h.download=s,h.click(),URL.revokeObjectURL(c),h.remove(),this.notify("Backup baixado com sucesso.","success")},triggerFileImport(){document.getElementById("import-file").click()},processImport(e){const t=e.target.files[0];if(!t)return;const i=new FileReader;i.onload=s=>{try{const a=JSON.parse(s.target.result);if(!a.chars)throw new Error("Arquivo inválido");this.chars={...this.chars,...a.chars},a.settings&&(this.settings={...this.settings,...a.settings},this.applyTheme(this.settings.themeColor)),this.updateAgentCount(),this.unsavedChanges=!0,this.notify(`${Object.keys(a.chars).length} personagens importados!`,"success"),this.configModal=!1}catch(a){console.error("Import error:",a),this.notify("Erro ao importar arquivo.","error")}},i.readAsText(t)},handleEscKey(){if(!this.systemFailure){if(this.confirmOpen){this.confirmOpen=!1;return}if(this.cropperOpen){this.cropperOpen=!1;return}if(this.welcomeModal){this.welcomeModal=!1;return}if(this.netlinkModal){this.netlinkModal=!1,this.netlinkCreateMode=!1;return}if(this.configModal){this.configModal=!1;return}if(this.wizardOpen){this.wizardOpen=!1;return}if(this.diceTrayOpen){this.diceTrayOpen=!1;return}if(this.userMenuOpen){this.userMenuOpen=!1;return}if(this.currentView==="sheet"){this.attemptGoBack();return}}},toggleHackerMode(){this.isHackerMode=!this.isHackerMode,this.isHackerMode?(document.body.classList.add("theme-hacker"),localStorage.setItem("zenite_hacker_mode","true"),l("success"),this.notify(">>> HACKER MODE ACTIVATED <<<","success"),this.localStats&&(this.localStats.hackerMode=!0,this.saveLocalStats(),this.checkAchievements())):(document.body.classList.remove("theme-hacker"),localStorage.removeItem("zenite_hacker_mode"),l("click"),this.notify("System mode restored.","info"))},handleLogoClick(){if(clearTimeout(this.logoClickTimer),this.logoClickCount++,this.logoClickCount>=5){this.logoClickCount=0,this.triggerSystemFailure();return}this.logoClickTimer=setTimeout(()=>{this.logoClickCount===1&&(this.activeCampaign&&this.leaveCampaign(),this.currentView="dashboard",this.selectedCharId=null,this.char=null),this.logoClickCount=0},300)},ensureTrayOnScreen(){this.isMobile||this.trayDockMode!=="float"||(this.trayPosition.x=Math.max(10,Math.min(window.innerWidth-320,this.trayPosition.x)),this.trayPosition.y=Math.max(60,Math.min(window.innerHeight-400,this.trayPosition.y)))},toggleDiceTray(){this.isReverting||!this.diceTrayOpen&&this.currentView!=="sheet"||(this.diceTrayOpen=!this.diceTrayOpen,this.diceTrayOpen&&(this.hasSeenDiceTip||(this.hasSeenDiceTip=!0,this.saveLocal()),this.showDiceTip=!1,this.trayDockMode==="float"&&!this.isMobile&&((!this.trayPosition.x||!this.trayPosition.y||this.trayPosition.y>window.innerHeight-100)&&(this.trayPosition={x:Math.max(20,window.innerWidth-340),y:100}),this.ensureTrayOnScreen())))},setDockMode(e){this.trayDockMode=e,e==="float"&&(this.trayPosition={x:Math.max(20,window.innerWidth-340),y:100},this.ensureTrayOnScreen()),this.saveLocal()},startDragTray(e){if(this.isMobile||this.trayDockMode!=="float"||e.target.closest("button")||e.target.closest("input"))return;const t=document.getElementById("dice-tray-window");if(!t)return;this.isDraggingTray=!0;const i=e.clientX,s=e.clientY,a=this.trayPosition.x,r=this.trayPosition.y;t.style.transition="none";const n=h=>{if(!this.isDraggingTray)return;const m=h.clientX-i,d=h.clientY-s;t.style.left=`${a+m}px`,t.style.top=`${r+d}px`},c=h=>{this.isDraggingTray=!1,document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",c);const m=h.clientX-i,d=h.clientY-s;this.trayPosition.x=a+m,this.trayPosition.y=r+d,t&&(t.style.transition=""),this.saveLocal()};document.addEventListener("mousemove",n),document.addEventListener("mouseup",c)},askClearAllChars(){this.askConfirm("LIMPAR TODAS AS FICHAS?","Isso irá DELETAR PERMANENTEMENTE todos os seus personagens. Esta ação é IRREVERSÍVEL!","danger",async()=>{if(this.configModal=!1,this.diceTrayOpen=!1,this.currentView="dashboard",this.activeCharId=null,await new Promise(e=>setTimeout(e,100)),this.char=null,this.chars={},this.saveLocal(),this.updateAgentCount(),!this.isGuest&&this.user&&this.supabase)try{await this.supabase.from("profiles").update({data:{config:this.settings}}).eq("id",this.user.id)}catch(e){console.error("Erro ao limpar nuvem:",e)}this.notify("Todas as fichas foram removidas.","success")})},askDeleteAccount(){this.askConfirm("APAGAR CONTA PERMANENTEMENTE?","Isso irá DELETAR sua conta e TODOS os dados. TEM CERTEZA?","danger",async()=>{if(!(!this.user||!this.supabase))try{await this.supabase.from("profiles").delete().eq("id",this.user.id),localStorage.clear(),await this.supabase.auth.signOut(),this.notify("Conta deletada com sucesso.","success"),setTimeout(()=>window.location.reload(),1500)}catch(e){console.error("Erro ao deletar conta:",e),this.notify("Erro ao deletar conta.","error")}})},openMacrosModal(){this.editingMacro=null,this.macrosModalOpen=!0},createNewMacro(){this.editingMacro={id:null,name:"",dice:"1d20",modifier:0,description:""}},editMacro(e){this.editingMacro={...e}},saveMacro(){if(!this.editingMacro||!this.editingMacro.name.trim()){this.notify("Nome da macro é obrigatório!","error");return}if(!this.editingMacro.dice.trim()){this.notify("Dados são obrigatórios!","error");return}if(this.editingMacro.id){const e=this.diceMacros.findIndex(t=>t.id===this.editingMacro.id);e!==-1&&(this.diceMacros[e]={...this.editingMacro})}else this.diceMacros.push({...this.editingMacro,id:"macro_"+Date.now()});this.editingMacro=null,this.saveLocal(),this.notify("Macro salva!","success"),l("success")},deleteMacro(e){this.diceMacros=this.diceMacros.filter(t=>t.id!==e),this.saveLocal(),this.notify("Macro removida.","success")},executeMacro(e){if(!e.dice)return;const t=/(\d+)d(\d+)([+-]\d+)?/i,i=e.dice.match(t);if(!i){this.notify("Formato de dados inválido!","error");return}const s=parseInt(i[1]),a=parseInt(i[2]),n=(i[3]?parseInt(i[3]):0)+(e.modifier||0);let c=[],h=0;for(let m=0;m<s;m++){const d=Math.floor(Math.random()*a)+1;c.push(d),h+=d}if(h+=n,this.activeCampaign&&!this.isGMOfActiveCampaign())this.rollForCampaign(`${s}d${a}`,n,e.name);else{const m=n>=0?`+${n}`:n,d=c.length>1?` (${c.join("+")})`:"";this.notify(`${e.name}: ${h}${d}${n!==0?" "+m:""}`,"info"),l("dice")}},checkUsername(){this.isGuest||!this.user||(!this.settings.username||this.settings.username.trim()==="")&&setTimeout(()=>{this.tempUsername=this.user?.email?.split("@")[0]||"",this.usernameModalOpen=!0},1500)},async confirmUsername(){if(!this.tempUsername||this.tempUsername.trim().length<2){this.notify("Username precisa ter pelo menos 2 caracteres!","error"),l("error");return}const e=this.tempUsername.trim();if(this.user&&this.supabase)try{const{data:t,error:i}=await this.supabase.rpc("change_username",{new_username:e});if(i)throw i;if(!t?.success){this.notify(t?.error||"Erro ao definir username","error"),l("error");return}this.settings.username=e,this.saveLocal(),this.usernameModalOpen=!1,this.notify("Username definido!","success"),l("save")}catch(t){console.error("[UI] Erro ao definir username:",t),this.notify("Erro ao definir username","error"),l("error")}else this.settings.username=e,this.saveLocal(),this.usernameModalOpen=!1,this.notify("Username definido!","success"),l("save")},async exportCharAsImage(){if(!this.char){this.notify("Nenhum personagem selecionado!","error");return}this.notify("Gerando imagem...","info");const e=document.createElement("canvas"),t=e.getContext("2d");e.width=600,e.height=900;const i=getComputedStyle(document.documentElement).getPropertyValue("--neon-core").trim()||"#0ea5e9",s=t.createLinearGradient(0,0,0,e.height);s.addColorStop(0,"#0a0a0f"),s.addColorStop(1,"#050508"),t.fillStyle=s,t.fillRect(0,0,e.width,e.height),t.strokeStyle=i,t.lineWidth=3,t.strokeRect(10,10,e.width-20,e.height-20);const a=t.createLinearGradient(0,0,e.width,0);a.addColorStop(0,i+"40"),a.addColorStop(1,"transparent"),t.fillStyle=a,t.fillRect(10,10,e.width-20,80),t.fillStyle=i,t.font='bold 28px "Orbitron", sans-serif',t.textAlign="center",t.fillText("ZENITE OS",e.width/2,55),t.fillStyle="#666",t.font="10px monospace",t.fillText("HERO ACADEMY DATABASE // AGENT FILE",e.width/2,75);const r=110,n=150,c=(e.width-n)/2;if(t.strokeStyle=i,t.lineWidth=2,t.strokeRect(c-5,r-5,n+10,n+10),this.char.photo)try{const p=new Image;p.crossOrigin="anonymous",await new Promise((f,C)=>{p.onload=f,p.onerror=C,p.src=this.char.photo}),t.drawImage(p,c,r,n,n)}catch{t.fillStyle="#1a1a1f",t.fillRect(c,r,n,n),t.fillStyle="#333",t.font='40px "Font Awesome 6 Free"',t.textAlign="center",t.fillText("?",e.width/2,r+90)}else t.fillStyle="#1a1a1f",t.fillRect(c,r,n,n),t.fillStyle=i+"60",t.font="60px sans-serif",t.textAlign="center",t.fillText(this.char.name?.charAt(0)?.toUpperCase()||"?",e.width/2,r+100);t.fillStyle="#fff",t.font='bold 32px "Orbitron", sans-serif',t.textAlign="center",t.fillText(this.char.name?.toUpperCase()||"SEM NOME",e.width/2,310),t.fillStyle=i,t.font="bold 16px sans-serif",t.fillText(this.char.class?.toUpperCase()||"SEM CLASSE",e.width/2,340),this.char.identity&&(t.fillStyle="#888",t.font="italic 14px sans-serif",t.fillText(`"${this.char.identity}"`,e.width/2,365)),t.strokeStyle=i+"40",t.lineWidth=1,t.beginPath(),t.moveTo(50,390),t.lineTo(e.width-50,390),t.stroke();const h=420,m=[{label:"NÍVEL",value:this.char.level||1,color:i},{label:"IDADE",value:this.char.age||"?",color:"#888"},{label:"PV",value:`${this.char.stats?.pv?.current||0}/${this.char.stats?.pv?.max||0}`,color:"#ef4444"},{label:"PF",value:`${this.char.stats?.pf?.current||0}/${this.char.stats?.pf?.max||0}`,color:"#3b82f6"}],d=(e.width-100)/m.length;m.forEach((p,f)=>{const C=50+d*f+d/2;t.fillStyle=p.color+"20",t.fillRect(50+d*f+5,h-25,d-10,55),t.fillStyle="#888",t.font="bold 10px sans-serif",t.textAlign="center",t.fillText(p.label,C,h-8),t.fillStyle=p.color,t.font='bold 20px "Orbitron", sans-serif',t.fillText(String(p.value),C,h+18)});const v=510;t.fillStyle="#666",t.font="bold 12px sans-serif",t.textAlign="center",t.fillText("ATRIBUTOS",e.width/2,v);const T=["FOR","AGI","INT","VON","POD"],b=[this.char.attrs?.for??0,this.char.attrs?.agi??0,this.char.attrs?.int??0,this.char.attrs?.von??0,this.char.attrs?.pod??0],E=(e.width-100)/5;if(T.forEach((p,f)=>{const C=50+E*f+E/2,y=b[f],A=y>=2?"#22c55e":y>=0?"#eab308":"#ef4444";t.fillStyle="#1a1a1f",t.fillRect(50+E*f+8,v+10,E-16,50),t.fillStyle="#888",t.font="bold 10px sans-serif",t.textAlign="center",t.fillText(p,C,v+28),t.fillStyle=A,t.font='bold 22px "Orbitron", sans-serif',t.fillText(y>=0?`+${y}`:String(y),C,v+52)}),this.char.history){t.fillStyle="#666",t.font="bold 12px sans-serif",t.textAlign="center",t.fillText("HISTÓRIA",e.width/2,600),t.fillStyle="#aaa",t.font="12px sans-serif",t.textAlign="center";const f=e.width-80,C=this.char.history.split(" ");let y="",A=620,I=0;for(let N of C){const x=y+N+" ";if(t.measureText(x).width>f&&y!==""){if(t.fillText(y.trim(),e.width/2,A),y=N+" ",A+=18,I++,I>=5){t.fillText("...",e.width/2,A);break}}else y=x}I<5&&y&&t.fillText(y.trim(),e.width/2,A)}const _=e.height-50;t.strokeStyle=i+"40",t.beginPath(),t.moveTo(50,_),t.lineTo(e.width-50,_),t.stroke(),t.fillStyle="#444",t.font="10px monospace",t.textAlign="center",t.fillText(`ID: ${this.char.id||"N/A"}`,e.width/2,_+20),t.fillText(`Gerado em ${new Date().toLocaleDateString("pt-BR")} via ZENITE OS`,e.width/2,_+35);try{const p=e.toDataURL("image/png"),f=document.createElement("a");f.download=`zenite_${this.char.name?.toLowerCase().replace(/\s+/g,"_")||"agente"}_${Date.now()}.png`,f.href=p,f.click(),this.notify("Imagem exportada com sucesso!","success"),l("save")}catch(p){console.error("Erro ao exportar imagem:",p),this.notify("Erro ao exportar imagem","error")}}},S={routes:{dashboard:{view:"dashboard",title:"Dashboard"},sheet:{view:"sheet",title:"Ficha",param:"charId"},netlink:{view:"campaign",title:"NetLink",param:"code"},login:{view:"login",title:"Login"}},init(e){this.app=e,window.addEventListener("popstate",()=>this.handleRoute()),this.handleRoute()},navigate(e,t=null,i=!1,s=!1){let a="/";e!=="dashboard"&&(a=`/${e}`,t&&(a+=`/${t}`));const r=window.location.origin+a;i?window.history.replaceState({route:e,param:t},"",r):window.history.pushState({route:e,param:t},"",r),s||this.processRoute(e,t),this.updateTitle()},handleRoute(){const t=window.location.pathname.split("/").filter(a=>a);if(window.location.hash.startsWith("#/")){const a=window.location.hash.slice(2).split("/").filter(c=>c),r=a[0]||"dashboard",n=a[1]||null;this.navigate(r,n,!0);return}const i=t[0]||"dashboard",s=t[1]||null;console.log("[ROUTER] HandleRoute -",i,s,"State:",window.history.state),this.processRoute(i,s)},processRoute(e,t){if(console.log("[ROUTER] Navegando para:",e,t),!this.app.user&&!this.app.isGuest&&e!=="login"){this.pendingRoute={route:e,param:t},this.updateTitle("Login");return}switch(e){case"dashboard":this.app.currentView="dashboard",this.updateTitle("Dashboard");break;case"sheet":if(t){const i=()=>{this.app.chars&&Object.keys(this.app.chars).length>0?this.app.loadChar(t).then(s=>{s?(this.app.currentView="sheet",this.updateTitle(this.app.char?.name||"Ficha")):this.navigate("dashboard",null,!0)}):setTimeout(i,200)};i()}else this.navigate("dashboard",null,!0);break;case"netlink":t&&this.app.netlinkEnabled?this.app.joinByCode&&this.app.joinByCode(t).then(i=>{i&&this.updateTitle(this.app.activeCampaign?.name||"NetLink")}).catch(()=>{this.app.notify("Campanha não encontrada","error"),this.navigate("dashboard",null,!0)}):this.navigate("dashboard",null,!0);break;case"login":(this.app.user||this.app.isGuest)&&this.navigate("dashboard",null,!0);break;default:this.navigate("dashboard",null,!0)}},redirectAfterLogin(){if(this.pendingRoute){const{route:e,param:t}=this.pendingRoute;this.pendingRoute=null,window.history.replaceState({route:e,param:t},"","/"),this.processRoute(e,t)}else window.history.replaceState({route:"dashboard"},"","/"),this.processRoute("dashboard",null)},getShareableUrl(){return window.location.href},async copyCurrentUrl(){const e=this.getShareableUrl();return await navigator.clipboard.writeText(e),this.app.notify("Link copiado!","success"),e},updateUrl(e,t=null){let i="/";e!=="dashboard"&&(i=`/${e}`,t&&(i+=`/${t}`)),window.history.replaceState({route:e,param:t},"",i)},updateTitle(e){const t=e?`ZENITE OS // ${e}`:"ZENITE OS";document.title=t,console.log("[ROUTER] Título atualizado:",t),setTimeout(()=>{document.title!==t&&(document.title=t,console.log("[ROUTER] Título forçado novamente"))},100)}},g={MAX_PLAYERS_PER_CAMPAIGN:8,MAX_CAMPAIGNS_PER_USER:5,INVITE_CODE_LENGTH:6,REALTIME_CHANNEL_PREFIX:"campaign:",DICE_LOG_RETENTION_DAYS:30,ROLES:{GM:"gm",PLAYER:"player"},MEMBER_STATUS:{ACTIVE:"active",PENDING:"pending",KICKED:"kicked"}},pe={myCampaigns:[],joinedCampaigns:[],activeCampaign:null,realtimeChannel:null,campaignMembers:[],sessionDiceLog:[],initiativeOrder:[],currentInitiativeIndex:0,netlinkView:"list",musicPlaylistOpen:!1,musicBtnRect:null,netlinkModal:!1,generateInviteCode(){const e="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";let t="";const i=new Uint8Array(g.INVITE_CODE_LENGTH);crypto.getRandomValues(i);for(let s=0;s<g.INVITE_CODE_LENGTH;s++)t+=e[i[s]%e.length];return t},async createCampaign(e,t=""){if(!this.supabase||!this.user)return this.notify("Você precisa estar logado para criar campanhas.","error"),null;if(this.myCampaigns.length>=g.MAX_CAMPAIGNS_PER_USER)return this.notify(`Limite de ${g.MAX_CAMPAIGNS_PER_USER} campanhas atingido.`,"error"),null;try{const i=this.generateInviteCode(),s=`ZC_${Date.now().toString(36).toUpperCase()}`,{data:a,error:r}=await this.supabase.from("campaigns").insert([{gm_id:this.user.id,name:e.trim(),code:s,invite_code:i,description:t.trim(),settings:{diceVisibility:"all",allowPlayerNotes:!0,showInitiativeOrder:!0}}]).select().single();if(r)throw r;return await this.supabase.from("campaign_members").insert([{campaign_id:a.id,user_id:this.user.id,role:g.ROLES.GM,status:g.MEMBER_STATUS.ACTIVE}]),this.myCampaigns.push(a),l("success"),this.notify("Campanha criada com sucesso!","success"),a}catch(i){return console.error("[NETLINK] Erro ao criar campanha:",i),this.notify("Erro ao criar campanha.","error"),null}},async joinCampaign(e,t){if(!this.supabase||!this.user)return this.notify("Você precisa estar logado para entrar em campanhas.","error"),!1;try{const{data:i,error:s}=await this.supabase.from("campaigns").select("*").eq("invite_code",e.toUpperCase()).single();if(s||!i)return this.notify("Código de convite inválido.","error"),!1;const{data:a}=await this.supabase.from("campaign_members").select("id").eq("campaign_id",i.id).eq("user_id",this.user.id).single();if(a)return this.notify("Você já está nesta campanha.","warn"),!1;const{count:r}=await this.supabase.from("campaign_members").select("id",{count:"exact"}).eq("campaign_id",i.id);if(r>=g.MAX_PLAYERS_PER_CAMPAIGN)return this.notify("Esta campanha está cheia.","error"),!1;if(!t||!this.chars[t])return this.notify("Você precisa selecionar um personagem para entrar.","error"),!1;const n=JSON.parse(JSON.stringify(this.chars[t])),{error:c}=await this.supabase.from("campaign_members").insert([{campaign_id:i.id,user_id:this.user.id,character_id:t,char_data:n,role:g.ROLES.PLAYER,status:g.MEMBER_STATUS.ACTIVE}]);if(c)throw c;return this.joinedCampaigns.push(i),l("success"),this.notify(`Você entrou em "${i.name}" com ${n.name||"seu personagem"}!`,"success"),this.netlinkModal=!1,await this.enterCampaign(i),!0}catch(i){return console.error("[NETLINK] Erro ao entrar na campanha:",i),this.notify("Erro ao entrar na campanha.","error"),!1}},async joinByCode(e){if(!e)return!1;if(this.activeCampaign?.invite_code?.toUpperCase()===e.toUpperCase())return console.log("[NETLINK] Já está na campanha:",e),!0;if(!this.supabase||!this.user)return sessionStorage.setItem("zenite_pending_campaign",e),this.notify("Faça login para entrar na campanha.","warn"),!1;try{const{data:t,error:i}=await this.supabase.from("campaigns").select("*").eq("invite_code",e.toUpperCase()).single();if(i||!t)return this.notify("Campanha não encontrada.","error"),!1;const{data:s}=await this.supabase.from("campaign_members").select("*").eq("campaign_id",t.id).eq("user_id",this.user.id).single();return s?(await this.enterCampaign(t),!0):(this.pendingCampaignCode=e,this.netlinkModal=!0,this.netlinkView="join",this.notify("Selecione um personagem para entrar na campanha.","info"),!0)}catch(t){return console.error("[NETLINK] Erro ao buscar campanha:",t),this.notify("Erro ao buscar campanha.","error"),!1}},async leaveCampaignAsMember(){if(!(!this.supabase||!this.user||!this.activeCampaign)){if(this.isGMOfActiveCampaign()){this.notify("O Mestre não pode abandonar a campanha. Delete-a se necessário.","error");return}try{const{error:e}=await this.supabase.from("campaign_members").delete().eq("campaign_id",this.activeCampaign.id).eq("user_id",this.user.id);if(e)throw e;this.joinedCampaigns=this.joinedCampaigns.filter(t=>t.id!==this.activeCampaign.id),l("success"),this.notify("Você saiu da campanha.","success"),await this.leaveCampaign()}catch(e){console.error("[NETLINK] Erro ao sair da campanha:",e),this.notify("Erro ao sair da campanha.","error")}}},async loadCampaigns(){if(!(!this.supabase||!this.user))try{const{data:e}=await this.supabase.from("campaigns").select("*").eq("gm_id",this.user.id).order("updated_at",{ascending:!1});this.myCampaigns=e||[];const{data:t}=await this.supabase.from("campaign_members").select("campaign_id, campaigns(*)").eq("user_id",this.user.id).eq("role",g.ROLES.PLAYER).eq("status",g.MEMBER_STATUS.ACTIVE);this.joinedCampaigns=t?.map(i=>i.campaigns).filter(Boolean)||[]}catch(e){console.error("[NETLINK] Erro ao carregar campanhas:",e)}},inspectMember(e){e.char_data&&(this.inspectedMember=JSON.parse(JSON.stringify(e)),this.memberInspectorOpen=!0)},closeInspector(){this.memberInspectorOpen=!1,this.inspectedMember=null},openMemberSheet(e){if(!e?.char_data){this.notify("Este membro não possui ficha.","warn");return}this.campaignCharBackup=this.char?JSON.parse(JSON.stringify(this.char)):null,this.campaignMemberId=e.id,this.campaignCharMode=!0,this.char=JSON.parse(JSON.stringify(e.char_data)),this.currentView="sheet",l("success")},openMySheet(){const e=this.getMyMembership();if(!e?.char_data){this.notify("Você não possui uma ficha nesta campanha.","warn");return}this.openMemberSheet(e)},async saveCampaignSheet(){if(!this.campaignCharMode||!this.campaignMemberId){console.warn("[NETLINK] saveCampaignSheet: modo inválido ou sem memberId");return}if(!this.char){console.error("[NETLINK] saveCampaignSheet: char é null"),this.notify("Erro: dados da ficha não encontrados.","error");return}console.log("[NETLINK] Salvando ficha do membro:",this.campaignMemberId);try{const{data:e,error:t}=await this.supabase.from("campaign_members").update({char_data:this.char}).eq("id",this.campaignMemberId).select();if(t)throw t;console.log("[NETLINK] Ficha salva com sucesso:",e),this.realtimeChannel&&(await this.realtimeChannel.send({type:"broadcast",event:"member_update",payload:{memberId:this.campaignMemberId}}),console.log("[NETLINK] Broadcast enviado")),this.notify("Ficha atualizada!","success"),l("save"),await this.loadCampaignMembers(this.activeCampaign.id)}catch(e){console.error("[NETLINK] Erro ao salvar ficha:",e),this.notify("Erro ao salvar ficha: "+e.message,"error")}},closeCampaignSheet(){this.campaignCharMode&&(this.campaignCharBackup&&(this.char=this.campaignCharBackup),this.campaignCharBackup=null,this.campaignMemberId=null,this.campaignCharMode=!1,this.currentView="campaign")},async saveInspectedMember(){if(!(!this.supabase||!this.inspectedMember))try{const{error:e}=await this.supabase.from("campaign_members").update({char_data:this.inspectedMember.char_data}).eq("id",this.inspectedMember.id);if(e)throw e;this.realtimeChannel&&this.realtimeChannel.send({type:"broadcast",event:"member_update",payload:{memberId:this.inspectedMember.id}}),l("success"),this.notify("Ficha do jogador atualizada!","success"),this.closeInspector(),await this.loadCampaignMembers(this.activeCampaign.id)}catch(e){console.error("[NETLINK] Erro ao salvar membro:",e),this.notify("Erro ao salvar alterações.","error")}},async connectToRealtime(e){if(!this.supabase)return;const t=`${g.REALTIME_CHANNEL_PREFIX}${e}`;if(this.realtimeChannel?.topic===t){console.log("[NETLINK] Já conectado ao canal:",t);return}this.realtimeChannel&&await this.supabase.removeChannel(this.realtimeChannel),console.log("[NETLINK] Conectando ao canal:",t),this.realtimeChannel=this.supabase.channel(t).on("postgres_changes",{event:"INSERT",schema:"public",table:"dice_logs",filter:`campaign_id=eq.${e}`},i=>{console.log("[REALTIME] Nova rolagem recebida"),this.handleNewDiceLog(i.new)}).on("postgres_changes",{event:"*",schema:"public",table:"campaign_members",filter:`campaign_id=eq.${e}`},()=>{console.log("[REALTIME] Lista de membros atualizada"),this.loadCampaignMembers(e)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"campaign_logs",filter:`campaign_id=eq.${e}`},i=>{console.log("[REALTIME] Nova mensagem de chat"),this.handleNewChatMessage(i.new)}).on("broadcast",{event:"initiative"},i=>this.handleInitiativeUpdate(i)).on("broadcast",{event:"member_update"},()=>{console.log("[REALTIME] Ficha de membro atualizada pelo GM"),this.loadCampaignMembers(e)}).on("broadcast",{event:"ambient_music"},i=>{console.log("[REALTIME] Comando de música recebido:",i.payload?.action),this.isGMOfActiveCampaign()||this.handleMusicCommand(i.payload)}).subscribe(i=>{console.log("[NETLINK] Status da conexão:",i),i==="SUBSCRIBED"?(console.log("✅ [NETLINK] Conectado ao realtime com sucesso!"),this.loadChatHistory(),this.loadCampaignMembers(e)):i==="CHANNEL_ERROR"||i==="TIMED_OUT"?(console.error("❌ [NETLINK] Erro na conexão realtime:",i),this.notify("Erro ao conectar tempo real. Chat pode não funcionar.","warn")):i==="CLOSED"&&console.warn("⚠️ [NETLINK] Conexão realtime fechada")})},async disconnectRealtime(){this.realtimeChannel&&this.supabase&&(await this.supabase.removeChannel(this.realtimeChannel),this.realtimeChannel=null)},async rollForCampaign(e,t=!1){if(!this.activeCampaign){this.roll(e);return}l("dice");const i=this.cryptoRandom(e),s=parseInt(this.diceMod||0),a=i+s,r=i===e,n=i===1;setTimeout(()=>{r?l("critical"):n&&l("fumble")},400),this.lastNatural=i,this.lastFaces=e,this.lastRoll=a;let c=`D${e}`;s!==0&&(c+=s>0?`+${s}`:`${s}`),this.playerLastRoll={formula:c,natural:i,modifier:s,total:a,isCrit:r,isFumble:n,reason:this.diceReason||"",timestamp:Date.now()},this.incrementStat&&(this.incrementStat("totalRolls"),r&&this.incrementStat("criticalRolls"),n&&this.incrementStat("fumbleRolls"));try{const{error:h}=await this.supabase.from("dice_logs").insert([{campaign_id:this.activeCampaign.id,user_id:this.user.id,username:this.char?.name||this.user.email?.split("@")[0]||"Anônimo",roll_data:{sides:e,natural:i,modifier:s,total:a,reason:this.diceReason},is_private:t,is_critical:r,is_fumble:n,natural_result:i,modifier:s,total_result:a,formula:c,reason:this.diceReason||null}]);if(h)throw h}catch(h){console.error("[NETLINK] Erro ao enviar rolagem:",h),this.notify("Erro ao sincronizar rolagem.","error")}this.diceReason=""},rollGMLocalDice(e=20){l("dice");const t=this.cryptoRandom(e),i=parseInt(this.gmDiceMod||0),s=t+i,a=t===e,r=t===1;setTimeout(()=>{a?l("critical"):r&&l("fumble")},400);let n=`D${e}`;i!==0&&(n+=i>0?`+${i}`:`${i}`),this.gmLocalDiceLog.unshift({id:Date.now(),formula:n,natural:t,modifier:i,total:s,isCrit:a,isFumble:r,timestamp:new Date().toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}),this.gmLocalDiceLog.length>20&&(this.gmLocalDiceLog=this.gmLocalDiceLog.slice(0,20)),this.gmDiceMod=0},clearGMDiceLog(){this.gmLocalDiceLog=[]},handleNewDiceLog(e){!this.activeCampaign||this.currentView!=="campaign"||e.is_private&&this.activeCampaign?.gm_id!==this.user?.id||(this.sessionDiceLog.unshift({id:e.id,username:e.username,formula:e.formula,result:e.total_result,natural:e.natural_result,mod:e.modifier,crit:e.is_critical,fumble:e.is_fumble,reason:e.reason,isPrivate:e.is_private,time:new Date(e.created_at).toLocaleTimeString("pt-BR")}),this.sessionDiceLog.length>100&&(this.sessionDiceLog=this.sessionDiceLog.slice(0,100)),e.user_id!==this.user?.id&&l("notification"))},handleNewChatMessage(e){if(!(!this.activeCampaign||this.currentView!=="campaign")&&!this.chatMessages.find(t=>t.id===e.id)){if(e.type==="whisper"){const t=this.activeCampaign?.gm_id===this.user?.id,i=e.metadata?.targetUserId===this.user?.id,s=e.user_id===this.user?.id;if(!t&&!i&&!s)return}this.chatMessages.push(e),e.user_id!==this.user?.id&&l("notification"),this.$nextTick(()=>{const t=document.getElementById("chat-container");t&&(t.scrollTop=t.scrollHeight)})}},addToInitiative(e,t,i=!1){this.initiativeOrder.push({id:Date.now(),name:e,value:parseInt(t)||0,isNPC:i,isActive:!1}),this.sortInitiative()},removeFromInitiative(e){this.initiativeOrder=this.initiativeOrder.filter(t=>t.id!==e)},clearInitiative(){this.initiativeOrder=[],this.currentInitiativeIndex=0},setActiveInitiative(e){this.initiativeOrder.forEach(i=>i.isActive=!1);const t=this.initiativeOrder.findIndex(i=>i.id===e);t!==-1&&(this.initiativeOrder[t].isActive=!0,this.currentInitiativeIndex=t),l("click")},sortInitiative(){this.initiativeOrder.sort((e,t)=>t.value-e.value)},nextInitiative(){this.initiativeOrder.length!==0&&(this.initiativeOrder.forEach(e=>e.isActive=!1),this.currentInitiativeIndex=(this.currentInitiativeIndex+1)%this.initiativeOrder.length,this.initiativeOrder[this.currentInitiativeIndex].isActive=!0,this.realtimeChannel&&this.realtimeChannel.send({type:"broadcast",event:"initiative",payload:{order:this.initiativeOrder,currentIndex:this.currentInitiativeIndex}}),l("click"))},handleInitiativeUpdate(e){!this.activeCampaign||this.currentView!=="campaign"||(this.initiativeOrder=e.payload.order,this.currentInitiativeIndex=e.payload.currentIndex)},resetInitiative(){this.initiativeOrder=[],this.currentInitiativeIndex=0},getMyMembership(){return!this.user||!this.campaignMembers?null:this.campaignMembers.find(e=>e.user_id===this.user.id)||null},async loadCampaignMembers(e){if(this.supabase)try{const{data:t}=await this.supabase.from("campaign_members").select("*").eq("campaign_id",e).eq("status",g.MEMBER_STATUS.ACTIVE);this.campaignMembers=t||[],this.campaignMembers=this.campaignMembers.map(i=>({...i,quickStats:i.char_data?{name:i.char_data.name||"Sem Nome",class:i.char_data.class||"Desconhecido",level:i.char_data.level||1,photo:i.char_data.photo||null,pv:i.char_data.stats?.pv||{current:0,max:0},pf:i.char_data.stats?.pf||{current:0,max:0},pdf:i.char_data.stats?.pdf||{current:0,max:0},attrs:i.char_data.attrs||{}}:null}))}catch(t){console.error("[NETLINK] Erro ao carregar membros:",t)}},async syncCharWithCampaign(){if(!(!this.supabase||!this.activeCampaign||!this.char)&&!this.isGMOfActiveCampaign())try{const{data:e}=await this.supabase.from("campaign_members").select("id").eq("campaign_id",this.activeCampaign.id).eq("user_id",this.user.id).single();if(!e)return;await this.supabase.from("campaign_members").update({char_data:JSON.parse(JSON.stringify(this.char))}).eq("id",e.id)}catch(e){console.error("[NETLINK] Erro ao sincronizar ficha:",e)}},getPlayersHealthSummary(){return this.isGMOfActiveCampaign()?this.campaignMembers.filter(e=>e.role===g.ROLES.PLAYER&&e.quickStats).map(e=>({memberId:e.id,userId:e.user_id,name:e.quickStats.name,photo:e.quickStats.photo,class:e.quickStats.class,level:e.quickStats.level,pv:e.quickStats.pv,pvPercent:e.quickStats.pv.max>0?Math.round(e.quickStats.pv.current/e.quickStats.pv.max*100):0,pf:e.quickStats.pf,pdf:e.quickStats.pdf,isLow:e.quickStats.pv.current<=e.quickStats.pv.max*.25,isDead:e.quickStats.pv.current<=0})):[]},async modifyPlayerStat(e,t,i="pv"){if(!this.supabase||!this.isGMOfActiveCampaign())return;const s=this.campaignMembers.find(c=>c.id===e);if(!s||!s.char_data)return;const a={...s.char_data};if(!a.stats||!a.stats[i])return;const r=a.stats[i].current,n=a.stats[i].max;a.stats[i].current=Math.max(0,Math.min(n,r-t));try{await this.supabase.from("campaign_members").update({char_data:a}).eq("id",e),this.realtimeChannel&&this.realtimeChannel.send({type:"broadcast",event:"member_update",payload:{memberId:e}}),await this.loadCampaignMembers(this.activeCampaign.id),l(t>0?"error":"success")}catch(c){console.error("[NETLINK] Erro ao modificar stat:",c)}},async updateMemberCharData(e,t){if(!(!this.supabase||!this.isGMOfActiveCampaign()))try{const{error:i}=await this.supabase.from("campaign_members").update({char_data:t}).eq("id",e);if(i)throw i;this.realtimeChannel&&this.realtimeChannel.send({type:"broadcast",event:"member_update",payload:{memberId:e}}),await this.loadCampaignMembers(this.activeCampaign.id),this.notify("Ficha atualizada!","success"),l("success")}catch(i){console.error("[NETLINK] Erro ao atualizar ficha:",i),this.notify("Erro ao atualizar ficha.","error")}},async kickMember(e){if(!this.supabase||!this.isGMOfActiveCampaign()){this.notify("Apenas o Mestre pode remover jogadores.","error");return}if(this.campaignMembers.find(i=>i.id===e)?.user_id===this.user?.id){this.notify("Você não pode remover a si mesmo.","error");return}try{const{error:i}=await this.supabase.from("campaign_members").delete().eq("id",e);if(i)throw i;await this.loadCampaignMembers(this.activeCampaign.id),l("success"),this.notify("Jogador removido da campanha.","success")}catch(i){console.error("[NETLINK] Erro ao remover membro:",i),this.notify("Erro ao remover jogador.","error")}},isGMOfActiveCampaign(){return this.activeCampaign?.gm_id===this.user?.id},async addToBestiary(e){if(!this.isGMOfActiveCampaign())return;const t=this.activeCampaign.settings?.bestiary||[];t.push({id:Date.now(),...e,createdAt:new Date().toISOString()}),await this.updateCampaignSettings({bestiary:t})},async updateCampaignSettings(e){if(!(!this.supabase||!this.isGMOfActiveCampaign()))try{const t={...this.activeCampaign.settings,...e},{error:i}=await this.supabase.from("campaigns").update({settings:t,updated_at:new Date().toISOString()}).eq("id",this.activeCampaign.id);if(i)throw i;this.activeCampaign.settings=t}catch(t){console.error("[NETLINK] Erro ao atualizar settings:",t)}},sessionTimerInterval:null,sessionStartTime:null,sessionElapsed:0,sessionTimerPaused:!1,startSessionTimer(){this.sessionTimerInterval||(this.sessionStartTime=Date.now()-this.sessionElapsed*1e3,this.sessionTimerPaused=!1,this.sessionTimerInterval=setInterval(()=>{this.sessionTimerPaused||(this.sessionElapsed=Math.floor((Date.now()-this.sessionStartTime)/1e3))},1e3),l("click"))},toggleSessionTimer(){this.sessionTimerPaused=!this.sessionTimerPaused,this.sessionTimerPaused||(this.sessionStartTime=Date.now()-this.sessionElapsed*1e3),l("click")},stopSessionTimer(){this.sessionTimerInterval&&(clearInterval(this.sessionTimerInterval),this.sessionTimerInterval=null),this.sessionElapsed=0,this.sessionStartTime=null,this.sessionTimerPaused=!1},formatSessionTime(){const e=Math.floor(this.sessionElapsed/3600),t=Math.floor(this.sessionElapsed%3600/60),i=this.sessionElapsed%60;return`${e.toString().padStart(2,"0")}:${t.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`},combatCalc:{damageInput:0,defenseInput:0,result:0,history:[]},calculateDamage(e,t,i=0){const s=Math.max(0,t-i),a=Math.max(0,e-s);return this.combatCalc.result=a,this.combatCalc.history.unshift({id:Date.now(),damage:e,defense:t,penetration:i,result:a,time:new Date().toLocaleTimeString("pt-BR")}),this.combatCalc.history.length>20&&(this.combatCalc.history=this.combatCalc.history.slice(0,20)),a},clearCombatHistory(){this.combatCalc.history=[],this.combatCalc.result=0},gmNotes:"",gmNotesAutoSave:null,updateGMNotes(e){this.gmNotes=e,clearTimeout(this.gmNotesAutoSave),this.gmNotesAutoSave=setTimeout(async()=>{if(this.activeCampaign&&this.isGMOfActiveCampaign())try{await this.supabase.from("campaigns").update({notes:e,updated_at:new Date().toISOString()}).eq("id",this.activeCampaign.id)}catch(t){console.error("[NETLINK] Erro ao salvar notas:",t)}},2e3)},chatMessages:[],chatInput:"",async sendChatMessage(e,t="chat"){if(!(!this.supabase||!this.activeCampaign||!e.trim()))try{const i=this.char?.name||this.settings?.username||this.user?.email?.split("@")[0]||"Anônimo",{error:s}=await this.supabase.from("campaign_logs").insert([{campaign_id:this.activeCampaign.id,user_id:this.user.id,sender:i,content:e.trim(),type:t,metadata:{isGM:this.isGMOfActiveCampaign()}}]);if(s)throw s;this.chatInput="",l("click"),this.incrementStat&&this.incrementStat("messagesSent")}catch(i){console.error("[NETLINK] Erro ao enviar mensagem:",i)}},async shareImageInChat(e,t="",i="image"){if(!this.supabase||!this.activeCampaign)return;if(!this.campaignSettings.imagesEnabled){this.notify("Imagens desabilitadas nesta campanha","warn");return}const s=i==="gif"||e.toLowerCase().includes(".gif")||e.toLowerCase().includes("giphy")||e.toLowerCase().includes("tenor");try{const a=this.char?.name||this.user?.email?.split("@")[0]||"Anônimo",{error:r}=await this.supabase.from("campaign_logs").insert([{campaign_id:this.activeCampaign.id,user_id:this.user.id,sender:a,content:t,type:s?"gif":"image",metadata:{isGM:this.isGMOfActiveCampaign(),imageUrl:e}}]);if(r)throw r;l("success")}catch(a){console.error("[NETLINK] Erro ao enviar imagem:",a),this.notify("Erro ao enviar imagem","error")}},async searchTenorGifs(e){if(!e||e.trim().length<2){this.tenorResults=[];return}this.tenorLoading=!0;try{const i=await fetch(`https://api.giphy.com/v1/gifs/search?api_key=GlVGYHkr3WSBnllca54iNt0yFbjz7L65&q=${encodeURIComponent(e)}&limit=24&rating=pg-13&lang=pt`);if(!i.ok)throw new Error("Giphy API error");const s=await i.json();this.tenorResults=(s.data||[]).map(a=>({id:a.id,title:a.title,preview:a.images?.fixed_height_small?.url||a.images?.preview_gif?.url,full:a.images?.original?.url||a.images?.downsized_medium?.url}))}catch(t){console.error("[GIPHY] Erro na busca:",t),this.tenorResults=[],this.notify("Erro ao buscar GIFs. Tente novamente.","warn")}finally{this.tenorLoading=!1}},async selectTenorGif(e){!e||!e.full||(await this.shareImageInChat(e.full,"","gif"),this.gifModalOpen=!1,this.tenorSearch="",this.tenorResults=[])},async loadChatHistory(e=50){if(!(!this.supabase||!this.activeCampaign))try{const{data:t}=await this.supabase.from("campaign_logs").select("*").eq("campaign_id",this.activeCampaign.id).order("created_at",{ascending:!1}).limit(e);this.chatMessages=(t||[]).reverse(),this.$nextTick(()=>{const i=document.getElementById("chat-container");i&&(i.scrollTop=i.scrollHeight)})}catch(t){console.error("[NETLINK] Erro ao carregar chat:",t)}},async sendWhisper(e,t){if(!(!this.supabase||!this.activeCampaign))try{const i=this.isGMOfActiveCampaign()?"GM":this.char?.name||"Jogador",{error:s}=await this.supabase.from("campaign_logs").insert([{campaign_id:this.activeCampaign.id,user_id:this.user.id,sender:i,content:t.trim(),type:"whisper",metadata:{targetUserId:e,isGM:this.isGMOfActiveCampaign()}}]);if(s)throw s;l("notification"),this.notify("Whisper enviado","success")}catch(i){console.error("[NETLINK] Erro ao enviar whisper:",i)}},async leaveCampaign(){this.activeCampaign&&(console.log("[NETLINK] Saindo da campanha..."),this.ambientMusic.playing&&(this.stopMusicLocally(),this.ambientMusic.playing=!1,this.ambientMusic.url=""),await this.disconnectRealtime(),this.stopSessionTimer(),this.activeCampaign=null,this.campaignMembers=[],this.sessionDiceLog=[],this.chatMessages=[],this.gmNotes="",this.netlinkView="list",S.navigate("dashboard"),this.switchDiceLogContext())},async enterCampaign(e){if(this.activeCampaign?.id===e.id&&this.currentView==="campaign"){console.log("[NETLINK] Já está na campanha:",e.id);return}this.activeCampaign=e,await Promise.all([this.loadCampaignMembers(e.id),this.loadChatHistory(),this.connectToRealtime(e.id)]),this.isGMOfActiveCampaign()&&(this.gmNotes=e.notes||"",this.loadBestiary(),this.loadCampaignSettings(),this.loadPlaylistFromLocal()),this.switchDiceLogContext(),this.currentView="campaign",this.netlinkView="campaign",e.invite_code&&S.navigate("netlink",e.invite_code,!1,!0),l("success")},async copyInviteCode(){if(this.activeCampaign?.invite_code)try{await navigator.clipboard.writeText(this.activeCampaign.invite_code),l("success"),this.notify("Código copiado!","success")}catch{this.notify("Erro ao copiar código","error")}},async copyInviteLink(){if(this.activeCampaign?.invite_code)try{const e=`${window.location.origin}${window.location.pathname}#/netlink/${this.activeCampaign.invite_code}`;await navigator.clipboard.writeText(e),l("success"),this.notify("Link copiado!","success")}catch{this.notify("Erro ao copiar link","error")}},async deleteCampaign(e){if(!(!this.supabase||!this.user))try{const t=this.myCampaigns.find(s=>s.id===e);if(!t||t.gm_id!==this.user.id){this.notify("Sem permissão para deletar","error");return}await this.supabase.from("campaign_members").delete().eq("campaign_id",e),await this.supabase.from("campaign_logs").delete().eq("campaign_id",e),await this.supabase.from("dice_logs").delete().eq("campaign_id",e);const{error:i}=await this.supabase.from("campaigns").delete().eq("id",e);if(i)throw i;this.myCampaigns=this.myCampaigns.filter(s=>s.id!==e),this.activeCampaign?.id===e&&await this.leaveCampaign(),l("success"),this.notify("Campanha deletada","success")}catch(t){console.error("[NETLINK] Erro ao deletar campanha:",t),this.notify("Erro ao deletar campanha","error")}},loadBestiary(){if(!this.activeCampaign)return;const e=`zenite_bestiary_${this.activeCampaign.id}`,t=localStorage.getItem(e);this.bestiary=t?JSON.parse(t):[]},saveBestiary(){if(!this.activeCampaign)return;const e=`zenite_bestiary_${this.activeCampaign.id}`;localStorage.setItem(e,JSON.stringify(this.bestiary))},openNewNPCModal(){this.editingNPC=JSON.parse(JSON.stringify(this.npcTemplate)),this.editingNPC.id=Date.now().toString(),this.bestiaryModalOpen=!0},editNPC(e){this.editingNPC=JSON.parse(JSON.stringify(e)),this.bestiaryModalOpen=!0},saveNPC(){if(!this.editingNPC||!this.editingNPC.name.trim()){this.notify("Nome do NPC é obrigatório","error");return}const e=this.bestiary.findIndex(t=>t.id===this.editingNPC.id);e>=0?this.bestiary[e]=this.editingNPC:this.bestiary.push(this.editingNPC),this.saveBestiary(),this.bestiaryModalOpen=!1,this.editingNPC=null,l("success")},deleteNPC(e){this.bestiary=this.bestiary.filter(t=>t.id!==e),this.saveBestiary(),l("click")},duplicateNPC(e){const t=JSON.parse(JSON.stringify(e));t.id=Date.now().toString(),t.name=t.name+" (cópia)",this.bestiary.push(t),this.saveBestiary(),l("success")},addNPCToInitiative(e){const t=this.cryptoRandom(20);this.addToInitiative(e.name,t,!0),l("dice")},updateNPCHP(e,t){const i=this.bestiary.find(s=>s.id===e);i&&(i.pv.current=Math.max(0,Math.min(i.pv.max,i.pv.current+t)),this.saveBestiary())},loadCampaignSettings(){if(!this.activeCampaign)return;const e=this.activeCampaign.settings||{};this.campaignSettings={chatEnabled:e.chatEnabled!==void 0?e.chatEnabled:!0,diceLogEnabled:e.diceLogEnabled!==void 0?e.diceLogEnabled:!0,imagesEnabled:e.imagesEnabled!==void 0?e.imagesEnabled:!0}},async saveCampaignSettings(){if(!(!this.supabase||!this.activeCampaign)){if(!this.isGMOfActiveCampaign()){this.notify("Apenas o Mestre pode alterar configurações.","error");return}try{const{error:e}=await this.supabase.from("campaigns").update({settings:this.campaignSettings,updated_at:new Date().toISOString()}).eq("id",this.activeCampaign.id);if(e)throw e;this.activeCampaign.settings={...this.campaignSettings},l("save"),this.notify("Configurações salvas!","success")}catch(e){console.error("[NETLINK] Erro ao salvar configurações:",e),this.notify("Erro ao salvar configurações.","error")}}},openMusicModal(){this.musicModalOpen=!0},extractYouTubeId(e){if(!e)return null;const t=/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/,i=e.match(t);return i&&i[2].length===11?i[2]:null},toggleMusic(){if(!this.ambientMusic.url){this.notify("Insira uma URL do YouTube primeiro!","warn");return}const e=this.extractYouTubeId(this.ambientMusic.url);if(!e){this.notify("URL do YouTube inválida!","error");return}this.ambientMusic.playing=!this.ambientMusic.playing,this.ambientMusic.playing?(this.playMusicLocally(e),this.realtimeChannel&&this.realtimeChannel.send({type:"broadcast",event:"ambient_music",payload:{action:"play",videoId:e,volume:this.ambientMusic.volume}}),this.notify("Música ambiente iniciada!","success")):(this.stopMusicLocally(),this.realtimeChannel&&this.realtimeChannel.send({type:"broadcast",event:"ambient_music",payload:{action:"stop"}}),this.notify("Música ambiente parada.","info"))},playMusicLocally(e){const t=document.getElementById("ambient-music-player");t&&(t.src=`https://www.youtube.com/embed/${e}?autoplay=1&loop=1&playlist=${e}&enablejsapi=1`,t.style.display="block")},stopMusicLocally(){const e=document.getElementById("ambient-music-player");e&&(e.src="",e.style.display="none")},playMusicFromUrl(e){const t=this.extractYouTubeId(e);if(!t){this.notify("URL do YouTube inválida!","error");return}this.ambientMusic.url=e,this.ambientMusic.playing=!0,this.playMusicLocally(t),this.realtimeChannel&&this.realtimeChannel.send({type:"broadcast",event:"ambient_music",payload:{action:"play",videoId:t,volume:this.ambientMusic.volume}}),this.notify("Tocando música!","success")},quickPlayMusic(e){this.playMusicFromUrl(e)},updateMusicVolume(){console.log("[MUSIC] Atualizando volume para:",this.ambientMusic.volume);const e=document.getElementById("ambient-music-player");e&&e.contentWindow&&this.setIframeVolume(e,this.ambientMusic.volume),this.realtimeChannel&&this.ambientMusic.playing&&(this.realtimeChannel.send({type:"broadcast",event:"ambient_music",payload:{action:"volume",volume:this.ambientMusic.volume}}),console.log("[MUSIC] Volume sincronizado via realtime"))},formatMusicTime(e){if(!e||isNaN(e))return"0:00";const t=Math.floor(e/60),i=Math.floor(e%60);return`${t}:${i.toString().padStart(2,"0")}`},seekMusic(e){if(!this.ambientMusic.playing){console.warn("[MUSIC] Música não está tocando");return}const i=e.currentTarget.getBoundingClientRect(),s=Math.max(0,Math.min(1,(e.clientX-i.left)/i.width));console.log("[MUSIC] Seeking para:",Math.round(s*100),"%");const a=document.getElementById("ambient-music-player");if(a&&a.contentWindow){const r=s*(this.ambientMusic.duration||1);a.contentWindow.postMessage(JSON.stringify({event:"command",func:"seekTo",args:[r,!0]}),"*"),this.ambientMusic.currentTime=r}this.realtimeChannel&&this.realtimeChannel.send({type:"broadcast",event:"ambient_music",payload:{action:"seek",time:seekTime}})},seekRelative(e){if(!this.ambientMusic.playing)return;const t=this.ambientMusic.currentTime||0,i=Math.max(0,Math.min(t+e,this.ambientMusic.duration||0)),s=document.getElementById("ambient-music-player");s&&s.contentWindow&&(s.contentWindow.postMessage(JSON.stringify({event:"command",func:"seekTo",args:[i,!0]}),"*"),this.ambientMusic.currentTime=i),this.realtimeChannel&&this.realtimeChannel.send({type:"broadcast",event:"ambient_music",payload:{action:"seek",time:i}})},updateMusicProgress(){if(!this.ambientMusic.playing)return;const e=document.getElementById("ambient-music-player");e&&e.contentWindow&&(e.contentWindow.postMessage(JSON.stringify({event:"listening",func:"getCurrentTime"}),"*"),e.contentWindow.postMessage(JSON.stringify({event:"listening",func:"getDuration"}),"*"))},addToPlaylist(e,t=""){const i=this.extractYouTubeId(e);if(!i){this.notify("URL do YouTube inválida!","error");return}if(this.musicPlaylist.some(a=>a.id===i)){this.notify("Música já está na playlist!","warn");return}const s={id:i,title:t||`Música ${this.musicPlaylist.length+1}`,url:e,thumbnail:`https://img.youtube.com/vi/${i}/mqdefault.jpg`};this.musicPlaylist.push(s),this.savePlaylistToLocal(),this.notify("Música adicionada à playlist!","success")},removeFromPlaylist(e){this.musicPlaylist=this.musicPlaylist.filter(t=>t.id!==e),this.savePlaylistToLocal(),this.notify("Música removida da playlist.","info")},playFromPlaylist(e){this.playMusicFromUrl(e.url)},savePlaylistToLocal(){this.activeCampaign&&localStorage.setItem(`zenite_playlist_${this.activeCampaign.id}`,JSON.stringify(this.musicPlaylist))},loadPlaylistFromLocal(){if(this.activeCampaign){const e=localStorage.getItem(`zenite_playlist_${this.activeCampaign.id}`);e?this.musicPlaylist=JSON.parse(e):this.musicPlaylist=[]}},handleMusicCommand(e){if(!this.activeCampaign||this.currentView!=="campaign")return;const t=document.getElementById("ambient-music-player");if(t)switch(e.action){case"play":t.src=`https://www.youtube.com/embed/${e.videoId}?autoplay=1&loop=1&playlist=${e.videoId}&enablejsapi=1`,t.style.display="block",this.ambientMusic.playing=!0,this.ambientMusic.url=`https://youtube.com/watch?v=${e.videoId}`,setTimeout(()=>{e.volume!==void 0&&this.setIframeVolume(t,e.volume)},1e3);break;case"stop":t.src="",t.style.display="none",this.ambientMusic.playing=!1;break;case"volume":this.setIframeVolume(t,e.volume);break;case"seek":this.setIframeSeek(t,e.time);break}},setIframeVolume(e,t){if(!(!e||!e.contentWindow))try{e.contentWindow.postMessage(JSON.stringify({event:"command",func:"setVolume",args:[t]}),"*")}catch(i){console.warn("[MUSIC] Erro ao definir volume:",i)}},setIframeSeek(e,t){if(!(!e||!e.contentWindow))try{e.contentWindow.postMessage(JSON.stringify({event:"command",func:"seekTo",args:[t,!0]}),"*")}catch(i){console.warn("[MUSIC] Erro ao fazer seek:",i)}}},R={first_roll:{id:"first_roll",name:"Primeiro Passo",description:"Role seu primeiro dado",icon:"fa-dice",color:"cyan",check:e=>e.totalRolls>=1},roll_master:{id:"roll_master",name:"Mestre dos Dados",description:"Role 100 dados",icon:"fa-dice-d20",color:"purple",check:e=>e.totalRolls>=100},critical_striker:{id:"critical_striker",name:"Golpe Crítico",description:"Tire um crítico natural",icon:"fa-burst",color:"green",check:e=>e.criticalRolls>=1},critical_legend:{id:"critical_legend",name:"Lenda Crítica",description:"Tire 10 críticos naturais",icon:"fa-crown",color:"gold",check:e=>e.criticalRolls>=10},fumble_survivor:{id:"fumble_survivor",name:"Sobrevivente",description:"Sobreviva a uma falha crítica",icon:"fa-skull",color:"red",check:e=>e.fumbleRolls>=1},first_char:{id:"first_char",name:"Nascimento",description:"Crie seu primeiro personagem",icon:"fa-user-plus",color:"cyan",check:e=>e.charsCreated>=1},collector:{id:"collector",name:"Colecionador",description:"Tenha 5 personagens",icon:"fa-users",color:"purple",check:e=>e.charsCreated>=5},army_builder:{id:"army_builder",name:"Construtor de Exércitos",description:"Tenha 15 personagens",icon:"fa-people-group",color:"gold",check:e=>e.charsCreated>=15},adventurer:{id:"adventurer",name:"Aventureiro",description:"Entre em uma campanha",icon:"fa-dungeon",color:"cyan",check:e=>e.campaignsJoined>=1},game_master:{id:"game_master",name:"Mestre de Jogo",description:"Crie uma campanha como GM",icon:"fa-chess-king",color:"yellow",check:e=>e.campaignsMastered>=1},veteran_gm:{id:"veteran_gm",name:"Mestre Veterano",description:"Mestre 5 campanhas",icon:"fa-hat-wizard",color:"gold",check:e=>e.campaignsMastered>=5},social_butterfly:{id:"social_butterfly",name:"Borboleta Social",description:"Adicione um amigo",icon:"fa-user-group",color:"pink",check:e=>e.friendsCount>=1},popular:{id:"popular",name:"Popular",description:"Tenha 10 amigos",icon:"fa-heart",color:"rose",check:e=>e.friendsCount>=10},chatterbox:{id:"chatterbox",name:"Tagarela",description:"Envie 50 mensagens no chat",icon:"fa-comments",color:"cyan",check:e=>e.messagesSent>=50},night_owl:{id:"night_owl",name:"Coruja Noturna",description:"Jogue entre meia-noite e 4h",icon:"fa-moon",color:"indigo",check:e=>e.nightOwl===!0},customizer:{id:"customizer",name:"Estiloso",description:"Mude o tema 3 vezes",icon:"fa-palette",color:"violet",check:e=>e.themeChanges>=3},konami_master:{id:"konami_master",name:"???",description:"Descubra o código secreto",icon:"fa-gamepad",color:"rainbow",secret:!0,check:e=>e.konamiActivated===!0},system_breaker:{id:"system_breaker",name:"???",description:"Quebre o sistema",icon:"fa-bug",color:"red",secret:!0,check:e=>e.systemFailure===!0},hacker_elite:{id:"hacker_elite",name:"???",description:"Entre no modo hacker",icon:"fa-terminal",color:"green",secret:!0,check:e=>e.hackerMode===!0},perfectionist:{id:"perfectionist",name:"Perfeccionista",description:"Tenha um personagem nível 10",icon:"fa-star",color:"gold",check:e=>e.maxLevel>=10},dice_addict:{id:"dice_addict",name:"Viciado em Dados",description:"Role 1000 dados",icon:"fa-dice",color:"rainbow",check:e=>e.totalRolls>=1e3},lucky_seven:{id:"lucky_seven",name:"???",description:"Tire 7 críticos seguidos",icon:"fa-clover",color:"green",secret:!0,check:e=>e.maxConsecutiveCrits>=7},unlucky:{id:"unlucky",name:"???",description:"Tire 5 falhas críticas seguidas",icon:"fa-face-sad-tear",color:"gray",secret:!0,check:e=>e.maxConsecutiveFumbles>=5},marathon_player:{id:"marathon_player",name:"Maratonista",description:"Jogue por 5 horas em uma sessão",icon:"fa-clock",color:"blue",check:e=>e.longestSession>=300},early_bird:{id:"early_bird",name:"Madrugador",description:"Jogue entre 5h e 7h da manhã",icon:"fa-sun",color:"orange",check:e=>e.earlyBird===!0},storyteller:{id:"storyteller",name:"Contador de Histórias",description:"Escreva mais de 500 caracteres no histórico de um personagem",icon:"fa-book",color:"amber",check:e=>e.longestHistory>=500},platinum:{id:"platinum",name:"PLATINA",description:"Conquiste todos os outros achievements",icon:"fa-trophy",color:"platinum",isPlatinum:!0,check:(e,t,i)=>t>=i-1}},fe={friends:[],friendRequests:[],friendsLoaded:!1,unlockedAchievements:[],localStats:{totalRolls:0,criticalRolls:0,fumbleRolls:0,consecutiveCrits:0,consecutiveFumbles:0,maxConsecutiveCrits:0,maxConsecutiveFumbles:0,charsCreated:0,maxLevel:1,longestHistory:0,campaignsJoined:0,campaignsMastered:0,messagesSent:0,friendsCount:0,themeChanges:0,nightOwl:!1,earlyBird:!1,longestSession:0,konamiActivated:!1,systemFailure:!1,hackerMode:!1},publicProfile:null,profileModalOpen:!1,friendsModalOpen:!1,achievementsModalOpen:!1,viewingProfile:null,usernameInput:"",usernameChecking:!1,usernameCheckResult:null,usernameCheckMessage:"",usernameCooldownDays:0,canChangeUsername:!0,usernameSaving:!1,initSocial(){const e=localStorage.getItem("zenite_local_stats");e&&(this.localStats={...this.localStats,...JSON.parse(e)});const t=localStorage.getItem("zenite_achievements");t&&(this.unlockedAchievements=JSON.parse(t)),this.localStats.charsCreated=Object.keys(this.chars||{}).length;const i=new Date().getHours();i>=0&&i<4&&(this.localStats.nightOwl=!0,this.saveLocalStats()),i>=5&&i<7&&(this.localStats.earlyBird=!0,this.saveLocalStats()),this.updateCharStats(),this.checkAchievements()},updateCharStats(){if(!this.chars)return;const e=Object.values(this.chars);this.localStats.charsCreated=e.length;let t=1,i=0;e.forEach(s=>{s.level&&s.level>t&&(t=s.level),s.history&&s.history.length>i&&(i=s.history.length)}),this.localStats.maxLevel=t,this.localStats.longestHistory=i,this.saveLocalStats()},saveLocalStats(){localStorage.setItem("zenite_local_stats",JSON.stringify(this.localStats))},checkAchievements(){let e=[];const t=Object.values(R),i=t.filter(a=>!a.isPlatinum).length,s=this.unlockedAchievements.filter(a=>a!=="platinum").length;return t.forEach(a=>{const r=this.unlockedAchievements.includes(a.id);let n;a.isPlatinum?n=a.check(this.localStats,s,i):n=a.check(this.localStats),!r&&n&&(this.unlockedAchievements.push(a.id),e.push(a))}),localStorage.setItem("zenite_achievements",JSON.stringify(this.unlockedAchievements)),e.forEach(a=>{this.showAchievementUnlock(a)}),e},showAchievementUnlock(e){l("success"),e.isPlatinum?(this.notify("🏆✨ PLATINA CONQUISTADA! ✨🏆","success"),this.triggerPlatinumEffect()):e.secret?this.notify(`🔓 Achievement Secreto: ${e.name}!`,"success"):this.notify(`🏆 Achievement: ${e.name}!`,"success")},triggerPlatinumEffect(){const e=document.createElement("div");e.className="platinum-celebration",e.innerHTML=`
            <div class="platinum-content">
                <div class="platinum-trophy">
                    <i class="fa-solid fa-trophy"></i>
                </div>
                <h2>PLATINA</h2>
                <p>Todos os achievements conquistados!</p>
            </div>
        `,document.body.appendChild(e),setTimeout(()=>{e.classList.add("fade-out"),setTimeout(()=>e.remove(),500)},4e3)},incrementStat(e,t=1){this.localStats[e]!==void 0&&(this.localStats[e]+=t,this.saveLocalStats(),this.checkAchievements())},getAchievementProgress(){const e=Object.keys(R).length,t=this.unlockedAchievements.length;return{unlocked:t,total:e,percentage:Math.round(t/e*100)}},async loadFriends(e=!1){if(!(!this.supabase||!this.user)&&!(this.friendsLoaded&&!e))try{const{data:t}=await this.supabase.from("friendships").select("id, friend_id, user_id, status, created_at").or(`user_id.eq.${this.user.id},friend_id.eq.${this.user.id}`).eq("status","accepted");if(t&&t.length>0){const s=t.map(n=>n.user_id===this.user.id?n.friend_id:n.user_id),{data:a}=await this.supabase.from("profiles").select("id, username, avatar_url").in("id",s),r=new Map(a?.map(n=>[n.id,n])||[]);this.friends=t.map(n=>{const c=n.user_id===this.user.id?n.friend_id:n.user_id,h=r.get(c);return{...n,friend_username:h?.username||null,friend_display_name:h?.username||null,friend_avatar:h?.avatar_url||null}})}else this.friends=[];const{data:i}=await this.supabase.from("friendships").select("id, user_id, created_at").eq("friend_id",this.user.id).eq("status","pending");if(i&&i.length>0){const s=i.map(n=>n.user_id),{data:a}=await this.supabase.from("profiles").select("id, username").in("id",s),r=new Map(a?.map(n=>[n.id,n.username])||[]);this.friendRequests=i.map(n=>({...n,sender_username:r.get(n.user_id)||null}))}else this.friendRequests=[];this.friendsLoaded=!0,this.localStats.friendsCount=this.friends.length,this.saveLocalStats(),this.checkAchievements()}catch(t){console.error("[SOCIAL] Erro ao carregar amigos:",t)}},async sendFriendRequest(e){if(!(!this.supabase||!this.user)){if(!e||e.trim().length<2){this.notify("Digite um username ou ID válido.","error");return}try{const t=e.trim();let{data:i}=await this.supabase.from("profiles").select("id, username").ilike("username",t).single();if(!i){const{data:r}=await this.supabase.from("profiles").select("id, username").eq("id",t).single();i=r}if(!i){this.notify("Usuário não encontrado. Verifique o username.","error");return}if(i.id===this.user.id){this.notify("Você não pode adicionar a si mesmo!","error");return}const{data:s}=await this.supabase.from("friendships").select("id, status").or(`and(user_id.eq.${this.user.id},friend_id.eq.${i.id}),and(user_id.eq.${i.id},friend_id.eq.${this.user.id})`);if(s&&s.length>0){s[0].status==="accepted"?this.notify("Vocês já são amigos!","warn"):this.notify("Já existe um pedido pendente.","warn");return}const{error:a}=await this.supabase.from("friendships").insert({user_id:this.user.id,friend_id:i.id,status:"pending"});if(a)throw a;this.notify(`Pedido enviado para ${i.username||"usuário"}!`,"success"),l("success")}catch(t){console.error("[SOCIAL] Erro ao enviar pedido:",t),this.notify("Erro ao enviar pedido. Tente novamente.","error")}}},async acceptFriendRequest(e){if(this.supabase)try{await this.supabase.from("friendships").update({status:"accepted"}).eq("id",e),this.notify("Amizade aceita!","success"),l("success"),await this.loadFriends(!0)}catch(t){console.error("[SOCIAL] Erro ao aceitar:",t)}},async rejectFriendRequest(e){if(this.supabase)try{await this.supabase.from("friendships").delete().eq("id",e),this.notify("Pedido recusado.","info"),await this.loadFriends(!0)}catch(t){console.error("[SOCIAL] Erro ao recusar:",t)}},async removeFriend(e){if(this.supabase)try{await this.supabase.from("friendships").delete().eq("id",e),this.notify("Amigo removido.","info"),await this.loadFriends(!0)}catch(t){console.error("[SOCIAL] Erro ao remover amigo:",t)}},async loadMyProfile(){if(!this.supabase||!this.user)return;const e=localStorage.getItem("zenite_my_profile");e&&(this.publicProfile=JSON.parse(e));try{const{data:t}=await this.supabase.from("profiles").select("*").eq("id",this.user.id).single();t&&(this.publicProfile=t,localStorage.setItem("zenite_my_profile",JSON.stringify(t)))}catch(t){console.error("[SOCIAL] Erro ao carregar perfil:",t)}},async updateProfile(e){if(!(!this.supabase||!this.user))try{if(e.username&&e.username!==this.publicProfile?.username){const{data:i,error:s}=await this.supabase.rpc("change_username",{new_username:e.username});if(s)throw s;if(!i?.success){this.notify(i?.error||"Erro ao alterar username","error");return}}const{error:t}=await this.supabase.from("profiles").update({bio:e.bio,is_public:e.isPublic,updated_at:new Date().toISOString()}).eq("id",this.user.id);if(t)throw t;this.publicProfile={...this.publicProfile,...e},localStorage.setItem("zenite_my_profile",JSON.stringify(this.publicProfile)),this.notify("Perfil atualizado!","success"),l("success")}catch(t){console.error("[SOCIAL] Erro ao atualizar perfil:",t),this.notify("Erro ao atualizar perfil.","error")}},async checkUsernameAvailable(e){if(!this.supabase||!e||e.length<3)return{available:!1,reason:"Mínimo 3 caracteres"};try{const{data:t,error:i}=await this.supabase.rpc("is_username_available",{new_username:e,current_user_id:this.user?.id||null});if(i)throw i;return{available:t,reason:t?"Disponível!":"Username já em uso"}}catch(t){return console.error("[SOCIAL] Erro ao verificar username:",t),{available:!1,reason:"Erro ao verificar"}}},async viewProfile(e){if(this.supabase)try{const{data:t}=await this.supabase.from("profiles").select("*").eq("id",e).eq("is_public",!0).single();t?(this.viewingProfile=t,this.profileModalOpen=!0):this.notify("Perfil não encontrado ou privado.","warn")}catch(t){console.error("[SOCIAL] Erro ao ver perfil:",t)}},openFriendsModal(){this.loadFriends(),this.friendsModalOpen=!0},openAchievementsModal(){this.achievementsModalOpen=!0},async openProfileModal(){await this.loadMyProfile(),await this.loadUsernameCooldown(),this.usernameInput=this.settings?.username||"",this.usernameCheckResult=null,this.usernameCheckMessage="",this.profileModalOpen=!0,this.viewingProfile=null},async loadUsernameCooldown(){if(!this.user||!this.supabase){this.usernameCooldownDays=0,this.canChangeUsername=!0;return}try{const{data:e,error:t}=await this.supabase.rpc("get_username_cooldown_days",{user_id:this.user.id});if(t){console.error("[USERNAME] Erro ao carregar cooldown:",t);const{data:i}=await this.supabase.from("profiles").select("username_changed_at").eq("id",this.user.id).single();if(i?.username_changed_at){const s=new Date(i.username_changed_at),a=new Date(s.getTime()+336*60*60*1e3),r=new Date;r<a?(this.usernameCooldownDays=Math.ceil((a-r)/(1440*60*1e3)),this.canChangeUsername=!1):(this.usernameCooldownDays=0,this.canChangeUsername=!0)}else this.usernameCooldownDays=0,this.canChangeUsername=!0;return}this.usernameCooldownDays=e||0,this.canChangeUsername=this.usernameCooldownDays===0,console.log("[USERNAME] Cooldown:",this.usernameCooldownDays,"dias")}catch(e){console.error("[USERNAME] Erro ao carregar cooldown:",e),this.usernameCooldownDays=0,this.canChangeUsername=!0}},async checkUsernameAvailable(e){if(!e||e.trim().length===0){this.usernameCheckResult=null,this.usernameCheckMessage="";return}const t=e.trim().toLowerCase();if(t.length<2){this.usernameCheckResult="invalid",this.usernameCheckMessage="Mínimo 2 caracteres";return}if(t.length>20){this.usernameCheckResult="invalid",this.usernameCheckMessage="Máximo 20 caracteres";return}if(!/^[a-z0-9_]+$/.test(t)){this.usernameCheckResult="invalid",this.usernameCheckMessage="Apenas letras, números e _";return}if(t===this.settings?.username?.toLowerCase()){this.usernameCheckResult=null,this.usernameCheckMessage="";return}this.usernameChecking=!0;try{if(this.supabase&&this.user){const{data:i,error:s}=await this.supabase.rpc("check_username_available",{check_username:t,current_user_id:this.user.id});if(s)throw s;i?(this.usernameCheckResult="available",this.usernameCheckMessage="Disponível!"):(this.usernameCheckResult="taken",this.usernameCheckMessage="Já está em uso")}else this.usernameCheckResult="available",this.usernameCheckMessage="Disponível (offline)"}catch(i){console.error("[USERNAME] Erro ao verificar:",i),this.usernameCheckResult=null,this.usernameCheckMessage="Erro ao verificar"}finally{this.usernameChecking=!1}},async saveUsername(){const e=this.usernameInput?.trim();if(!e||e.length<2){this.notify("Username precisa ter pelo menos 2 caracteres!","error"),l("error");return}if(!this.canChangeUsername){this.notify(`Aguarde ${this.usernameCooldownDays} dias para alterar.`,"warn");return}if(this.usernameCheckResult==="taken"||this.usernameCheckResult==="invalid"){this.notify("Username inválido ou já em uso!","error"),l("error");return}this.usernameSaving=!0;try{if(this.supabase&&this.user){const{data:t,error:i}=await this.supabase.rpc("change_username",{new_username:e});if(i)throw i;if(!t?.success){this.notify(t?.error||"Erro ao alterar username","error"),l("error");return}this.settings.username=t.username||e.toLowerCase(),this.saveLocal(),this.notify("Username alterado com sucesso!","success"),l("save"),await this.loadUsernameCooldown(),await this.loadMyProfile(),this.usernameCheckResult=null,this.usernameCheckMessage=""}else this.settings.username=e.toLowerCase(),this.saveLocal(),this.notify("Username alterado!","success"),l("save")}catch(t){console.error("[USERNAME] Erro ao salvar:",t),this.notify("Erro ao alterar username","error"),l("error")}finally{this.usernameSaving=!1}}};function $(){return{systemLoading:!0,loadingProgress:0,loadingText:"BOOT",loadingChar:!1,rebooting:!1,netlinkEnabled:J.NETLINK_ENABLED,user:null,isGuest:!1,userMenuOpen:!1,authLoading:!1,authMsg:"",authMsgType:"",authMode:"login",authEmail:"",authPassword:"",authPasswordConfirm:"",authUsername:"",usernameChecking:!1,usernameCheckResult:null,currentView:"dashboard",activeTab:"profile",logisticsTab:"inventory",searchQuery:"",viewMode:"grid",chars:{},activeCharId:null,char:null,agentCount:0,profile:null,settings:{compactMode:!1,crtMode:!1,sfxEnabled:!0,themeColor:"cyan",username:"",bio:"",dashboardView:"grid",dashboardSort:"recent"},diceMacros:[],macrosModalOpen:!1,editingMacro:null,ambientMusic:{url:"",playing:!1,volume:50,currentTime:0,duration:0},musicModalOpen:!1,musicPlaylist:[],playlistModalOpen:!1,wizardOpen:!1,wizardStep:1,wizardPoints:8,wizardNameError:!1,wizardFocusAttr:"",wizardData:{class:"",name:"",identity:"",age:"",history:"",photo:null,attrs:{for:-1,agi:-1,int:-1,von:-1,pod:-1}},notifications:[],configModal:!1,confirmOpen:!1,confirmData:{title:"",desc:"",action:null,type:"danger"},welcomeModal:!1,historyModal:!1,usernameModalOpen:!1,tempUsername:"",netlinkModal:!1,netlinkCreateMode:!1,netlinkJoinCode:"",wizardFromNetlink:!1,memberInspectorOpen:!1,inspectedMember:null,netlinkView:"list",playerSheetOpen:!1,unsavedChanges:!1,isSyncing:!1,saveStatus:"idle",revertConfirmMode:!1,shakeAlert:!1,isReverting:!1,autoSaveEnabled:!1,lastManualSave:null,gifModalOpen:!1,tenorSearch:"",tenorResults:[],tenorLoading:!1,usernameCheckStatus:"",usernameCheckMessage:"",canEditUsername:!0,daysUntilUsernameChange:0,cropperOpen:!1,cropperInstance:null,uploadContext:"char",campaignCharMode:!1,campaignCharBackup:null,campaignMemberId:null,diceTrayOpen:!1,trayDockMode:"float",trayPosition:{x:100,y:100},isDraggingTray:!1,showDiceTip:!1,hasSeenDiceTip:!1,diceLog:[],lastRoll:"--",lastNatural:0,lastFaces:20,diceMod:0,diceReason:"",gmLocalDiceLog:[],gmDiceFaces:20,gmDiceMod:0,bestiary:[],bestiaryModalOpen:!1,editingNPC:null,npcTemplate:{id:null,name:"",type:"enemy",pv:{current:10,max:10},pf:{current:5,max:5},pdf:{current:5,max:5},defesa:10,notes:"",tags:[]},campaignSettingsOpen:!1,campaignSettings:{chatEnabled:!0,diceLogEnabled:!0,imagesEnabled:!0},saveHistory:[],systemFailure:!1,minigameActive:!1,minigameClicks:5,minigamePos:{x:50,y:50},isHackerMode:!1,hackerModeUnlocked:!1,konamiBuffer:[],logoClickCount:0,logoClickTimer:null,isMobile:window.innerWidth<768,supabase:null,debouncedSaveFunc:null,archetypes:j,playerLastRoll:null,...ue,...de,...me,...pe,...fe,ACHIEVEMENTS:R,get filteredChars(){if(!this.searchQuery)return this.chars;const e=this.searchQuery.toLowerCase(),t={};return Object.keys(this.chars).forEach(i=>{const s=this.chars[i];(s.name&&s.name.toLowerCase().includes(e)||s.class&&s.class.toLowerCase().includes(e))&&(t[i]=s)}),t},get sortedChars(){const e=this.filteredChars,t=Object.entries(e),i=this.settings?.dashboardSort||"recent";return t.sort(([s,a],[r,n])=>{switch(i){case"name":return(a.name||"").localeCompare(n.name||"");case"class":return(a.class||"").localeCompare(n.class||"");case"level":return(n.level||1)-(a.level||1);case"recent":default:return r.localeCompare(s)}}),Object.fromEntries(t)},async initSystem(){if(this.loadingProgress=20,document.body.addEventListener("click",()=>z(),{once:!0}),this.setupListeners(),typeof window.supabase<"u"&&(this.supabase=window.supabase.createClient(L.SUPABASE_URL,L.SUPABASE_KEY)),this.debouncedSaveFunc=le(async()=>{this.autoSaveEnabled&&(await this.saveLocal(),!this.isGuest&&this.user&&(await this.syncCloud(!0),l("save")),this.isSyncing=!1,this.unsavedChanges=!1,this.autoSaveEnabled=!1)},3e3),localStorage.getItem("zenite_is_guest")==="true")this.isGuest=!0,this.loadLocal("zenite_guest_db");else if(this.loadLocal("zenite_cached_db"),this.supabase)try{const{data:{session:t}}=await this.supabase.auth.getSession();t&&(this.user=t.user,this.loadingText="SYNC CLOUD",await this.fetchCloud(),this.checkOnboarding()),this.supabase.auth.onAuthStateChange(async(i,s)=>{if(i==="SIGNED_IN"&&s){if(this.user?.id===s.user.id)return;this.user=s.user,this.isGuest=!1,localStorage.removeItem("zenite_is_guest"),await this.fetchCloud(),this.checkOnboarding()}else i==="SIGNED_OUT"&&(this.user=null,this.chars={},this.currentView="dashboard")})}catch(t){console.warn("[AUTH] Erro na inicialização:",t)}this.loadHistory(),this.loadDiceHistory(),this.settings&&(this.settings.themeColor&&this.applyTheme(this.settings.themeColor),P(this.settings.sfxEnabled),this.updateVisualState(),this.settings.compactMode&&this.isMobile&&this.applyCompactMode()),this.$watch("char",t=>{!t||this.loadingChar||this.isReverting||(this.char&&(this.char.lastAccess=Date.now()),this.unsavedChanges=!0)}),this.$watch("settings.sfxEnabled",t=>P(t)),this.$watch("settings.crtMode",()=>this.updateVisualState()),this.updateAgentCount(),this.initSocial(),this.checkUsername(),this.loadingProgress=100,setTimeout(()=>{this.systemLoading=!1,S.init(this)},500),setInterval(()=>{this.user&&this.unsavedChanges&&this.autoSaveEnabled&&this.syncCloud(!0)},L.SAVE_INTERVAL)},async checkOnboarding(){if(!this.user||!this.supabase){localStorage.getItem("zenite_welcome_seen")||setTimeout(()=>{this.welcomeModal=!0,localStorage.setItem("zenite_welcome_seen","true")},1e3);return}try{const{data:e}=await this.supabase.from("profiles").select("has_seen_welcome").eq("id",this.user.id).single();e?.has_seen_welcome||setTimeout(()=>{this.welcomeModal=!0,this.supabase.from("profiles").update({has_seen_welcome:!0}).eq("id",this.user.id).then(()=>console.log("[SYSTEM] Welcome marked as seen"))},1e3)}catch(e){console.error("[SYSTEM] Erro ao verificar onboarding:",e)}},setupListeners(){window.addEventListener("pageshow",t=>{t.persisted&&window.location.reload()});let e;window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{const t=this.isMobile;this.isMobile=window.innerWidth<768,t!==this.isMobile&&(this.diceTrayOpen=!1,this.userMenuOpen=!1,this.showDiceTip=!1,this.trayDockMode==="float"&&(this.trayPosition={x:Math.max(20,window.innerWidth-340),y:100})),this.currentView!=="sheet"&&this.diceTrayOpen&&(this.diceTrayOpen=!1)},150)}),window.addEventListener("popstate",()=>{if(this.currentView==="sheet"&&this.unsavedChanges&&!this.isGuest){history.pushState(null,null,location.href),this.triggerShake();return}(this.currentView==="sheet"||this.wizardOpen||this.configModal)&&(this.currentView==="sheet"&&this.saveAndExit(!0),this.wizardOpen=!1,this.configModal=!1,this.cropperOpen=!1)}),document.addEventListener("click",t=>{t.target.closest("button, a, input, select, .cursor-pointer, .dice-tray-opt")&&l("click")}),window.addEventListener("message",t=>{if(t.origin==="https://www.youtube.com")try{const i=JSON.parse(t.data);i.event==="infoDelivery"&&i.info&&(i.info.currentTime!==void 0&&(this.ambientMusic.currentTime=i.info.currentTime),i.info.duration!==void 0&&i.info.duration>0&&(this.ambientMusic.duration=i.info.duration))}catch{}}),setInterval(()=>{this.ambientMusic.playing&&this.updateMusicProgress()},1e3),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.handleEscKey()})},async manualSave(){this.unsavedChanges&&(this.notify("Salvando...","info"),this.isSyncing=!0,this.saveToHistory(),await this.saveLocal(),!this.isGuest&&this.user&&(await this.syncCloud(!0),l("save")),this.isSyncing=!1,this.unsavedChanges=!1,this.autoSaveEnabled=!1,this.notify("Salvo com sucesso!","success"))},saveToHistory(){if(!this.char||!this.activeCharId)return;const e={id:Date.now(),charId:this.activeCharId,timestamp:new Date().toISOString(),data:JSON.parse(JSON.stringify(this.char))};this.saveHistory.unshift(e),this.saveHistory.length>50&&(this.saveHistory=this.saveHistory.slice(0,50)),localStorage.setItem("zenite_history",JSON.stringify(this.saveHistory))},loadHistory(){const e=localStorage.getItem("zenite_history");if(e)try{this.saveHistory=JSON.parse(e)}catch{this.saveHistory=[]}},restoreFromHistory(e){const t=this.saveHistory.find(i=>i.id===e);t&&this.askConfirm("RESTAURAR VERSÃO?",`Isso irá sobrescrever os dados atuais com a versão de ${new Date(t.timestamp).toLocaleString("pt-BR")}`,"warn",()=>{this.char=k(t.data),this.unsavedChanges=!0,this.historyModal=!1,this.notify("Versão restaurada! Clique em SALVAR para confirmar.","success"),this.triggerShake()})},triggerSystemFailure(){l("error"),this.systemFailure=!0,this.minigameActive=!1;const e=document.documentElement;e.requestFullscreen&&e.requestFullscreen().catch(()=>{}),this.localStats&&(this.localStats.systemFailure=!0,this.saveLocalStats(),this.checkAchievements())},startMinigame(){this.minigameActive=!0,this.minigameClicks=5,this.moveMinigameTarget()},moveMinigameTarget(){this.minigamePos.x=Math.floor(Math.random()*80)+10,this.minigamePos.y=Math.floor(Math.random()*80)+10},hitMinigame(){l("click"),this.minigameClicks--,this.minigameClicks<=0?(l("success"),this.notify("SISTEMA RESTAURADO","success"),this.systemFailure=!1,this.minigameActive=!1,document.exitFullscreen&&document.exitFullscreen().catch(()=>{}),this.rebooting=!0,setTimeout(()=>{this.rebooting=!1},1e3)):this.moveMinigameTarget()},notify(e,t="info"){const i=Date.now();let s="fa-circle-info";t==="success"&&(s="fa-circle-check"),t==="error"&&(s="fa-triangle-exclamation"),t==="warn"&&(s="fa-bell"),this.notifications.push({id:i,message:e,type:t,icon:s}),setTimeout(()=>{this.notifications=this.notifications.filter(a=>a.id!==i)},3e3)},handleKeys(e){if(!e.key)return;const t=e.key.toLowerCase(),i=["arrowup","arrowup","arrowdown","arrowdown","arrowleft","arrowright","arrowleft","arrowright","b","a"];this.konamiBuffer.push(t),this.konamiBuffer.length>i.length&&this.konamiBuffer.shift(),JSON.stringify(this.konamiBuffer)===JSON.stringify(i)&&(this.hackerModeUnlocked=!0,localStorage.setItem("zenite_hacker_unlocked","true"),this.toggleHackerMode(),this.konamiBuffer=[],this.localStats&&(this.localStats.konamiActivated=!0,this.saveLocalStats(),this.checkAchievements()))},goToDashboard(){S.navigate("dashboard"),this.currentView="dashboard"},async openSheet(e){await this.loadChar(e)&&(S.navigate("sheet",e),this.currentView="sheet")},async openCampaign(e){S.navigate("netlink",e)},async copyPageLink(){await S.copyCurrentUrl()},getSheetShareUrl(){return this.activeCharId?`${window.location.origin}${window.location.pathname}#/sheet/${this.activeCharId}`:null},getCampaignShareUrl(){return this.activeCampaign?.invite_code?`${window.location.origin}${window.location.pathname}#/netlink/${this.activeCampaign.invite_code}`:null}}}window.zeniteSystem=$;document.addEventListener("DOMContentLoaded",async()=>{const[e,t]=await Promise.all([V(()=>import("https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/module.esm.js"),[]),V(()=>import("https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.13.3/dist/module.esm.js"),[])]),i=e.default,s=t.default;i.plugin(s),i.data("zeniteSystem",$),i.start()});
